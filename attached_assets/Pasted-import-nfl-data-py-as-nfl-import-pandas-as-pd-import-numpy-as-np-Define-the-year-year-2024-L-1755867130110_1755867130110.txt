import nfl_data_py as nfl
import pandas as pd
import numpy as np

# Define the year
year = 2024

# Load seasonal player data for regular season
seasonal_df = nfl.import_seasonal_data([year])

# Filter to regular season if season_type exists
if 'season_type' in seasonal_df.columns:
    seasonal_df = seasonal_df[seasonal_df['season_type'] == 'REG']

# Filter for relevant positions
seasonal_df = seasonal_df[seasonal_df['position'].isin(['QB', 'RB', 'WR', 'TE'])]

# Load NGS data if needed for advanced metrics (but leave most null as per notes)
# ngs_receiving = nfl.import_ngs_data('receiving', [year])
# ngs_rushing = nfl.import_ngs_data('rushing', [year])
# ngs_passing = nfl.import_ngs_data('passing', [year])
# Note: Not merging here as advanced fields like yprr, rush_yac_per_att not directly available; set to null

# Team/games robustness
if 'games' not in seasonal_df.columns and 'games_played' in seasonal_df.columns:
    seasonal_df['games'] = seasonal_df['games_played']

# Compute derived fields, guarding against divide by zero
seasonal_df['cmp_pct'] = np.where(seasonal_df['attempts'] > 0, (seasonal_df['completions'] / seasonal_df['attempts']) * 100, np.nan)
seasonal_df['ypa'] = np.where(seasonal_df['attempts'] > 0, seasonal_df['passing_yards'] / seasonal_df['attempts'], np.nan)
seasonal_df['aypa'] = np.where(
    seasonal_df['attempts'] > 0,
    (seasonal_df['passing_yards'] + 20 * seasonal_df['passing_tds'] - 45 * seasonal_df['interceptions']) / seasonal_df['attempts'],
    np.nan
)
if 'passing_epa' not in seasonal_df.columns:
    seasonal_df['passing_epa'] = np.nan
seasonal_df['epa_per_play'] = np.where(seasonal_df['attempts'] > 0,
                                       seasonal_df['passing_epa'] / seasonal_df['attempts'],
                                       np.nan)
seasonal_df['rush_ypc'] = np.where(seasonal_df['rush_attempts'] > 0, seasonal_df['rush_yards'] / seasonal_df['rush_attempts'], np.nan)

# Compute td_total for RBs
seasonal_df['td_total'] = seasonal_df['rush_tds'] + seasonal_df['receiving_tds']

# Keep QB rush in both places
seasonal_df['qb_rush_yards'] = np.where(seasonal_df['position'] == 'QB', seasonal_df['rush_yards'], np.nan)
seasonal_df['qb_rush_tds'] = np.where(seasonal_df['position'] == 'QB', seasonal_df['rush_tds'], np.nan)

# Set advanced fields to null as not available or nullable
seasonal_df['rush_yac_per_att'] = np.nan
seasonal_df['rush_mtf'] = np.nan
seasonal_df['rush_expl_10p'] = np.nan
seasonal_df['yprr'] = np.nan
seasonal_df['adot'] = np.nan
seasonal_df['routes'] = np.nan
seasonal_df['racr'] = np.nan
seasonal_df['target_share'] = np.nan
seasonal_df['wopr'] = np.nan
seasonal_df['epa_per_play'] = np.where(seasonal_df['position'] != 'QB', np.nan, seasonal_df['epa_per_play'])  # Nullable for non-QB

# Rename columns to match schema
rename_map = {
    'player_id': 'player_id',
    'player_name': 'player_name',
    'position': 'position',
    'recent_team': 'team',
    'games': 'games',
    'fantasy_points': 'fpts',
    'fantasy_points_ppr': 'fpts_ppr',
    'targets': 'targets',
    'receptions': 'receptions',
    'receiving_yards': 'rec_yards',
    'receiving_tds': 'rec_tds',
    'rush_attempts': 'rush_att',
    'rush_yards': 'rush_yards',
    'rush_tds': 'rush_tds',
    'completions': 'cmp',
    'attempts': 'att',
    'passing_yards': 'pass_yards',
    'passing_tds': 'pass_tds',
    'interceptions': 'int'
}
seasonal_df = seasonal_df.rename(columns=rename_map)

# Select only schema columns, filling any missing with np.nan
schema_columns = [
    'player_id', 'player_name', 'position', 'team', 'games', 'fpts', 'fpts_ppr',
    'targets', 'receptions', 'rec_yards', 'rec_tds', 'routes', 'yprr', 'adot', 'racr', 'target_share', 'wopr',
    'rush_att', 'rush_yards', 'rush_tds', 'rush_ypc', 'rush_yac_per_att', 'rush_mtf', 'rush_expl_10p',
    'cmp', 'att', 'cmp_pct', 'pass_yards', 'pass_tds', 'int', 'ypa', 'aypa', 'epa_per_play',
    'qb_rush_yards', 'qb_rush_tds', 'td_total'
]
final_df = seasonal_df.reindex(columns=schema_columns, fill_value=np.nan)

# Save to CSV
final_df.to_csv('data/player_season_2024.csv', index=False)

print("2024 player season data ingested and saved to data/player_season_2024.csv")
(The CSV is generated by running the script above; since this is a text response, the actual file would be produced on execution. Advanced fields like yprr, adot, rush_yac_per_att, rush_mtf, rush_expl_10p, racr, target_share, wopr, and routes are left null as they require PBP-derived data not directly available in the seasonal aggregate without additional processing.)
