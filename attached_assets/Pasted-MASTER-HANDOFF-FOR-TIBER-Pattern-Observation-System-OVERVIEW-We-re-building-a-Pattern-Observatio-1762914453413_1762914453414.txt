MASTER HANDOFF FOR TIBER - Pattern Observation System

OVERVIEW
We're building a "Pattern Observation Bank" - teaching TIBER evaluation frameworks (not just player facts) using curated insights from X/Twitter analysts. This requires three integrated systems:

Pattern Chunks - Observations that teach thinking patterns
Jargon Dictionary - Maps analysis terms to NFLfastR API fields
Data Validation - Queries live data to validate/extend observations


SYSTEM 1: PATTERN OBSERVATION CHUNKS
Chunk Structure
typescript{
  content: string,  // The observation + fantasy implications + pattern teaching
  embedding: vector(768),  // Gemini embedding
  metadata: {
    // Classification
    type: "pattern_observation" | "player_insight" | "team_context" | "historical_benchmark",
    pattern_type: string,  // Specific pattern name
    
    // Attribution (Legal Compliance)
    source: "twitter" | "nflfastr_analysis" | "historical_research" | "aggregated_data_analysis",
    source_handle?: string,  // Twitter handle if applicable
    source_url?: string,  // Link to original post
    observation_date: string,  // YYYY-MM-DD
    
    // Applicability
    applicable_to: string[],  // ["wr", "rb", "all_teams"]
    position?: string,
    team?: string,
    player_id?: string,
    
    // Teaching
    teaches: string,  // What evaluation framework this teaches
    tags: string[],
    confidence: "high" | "medium" | "low",
    
    // Data Integration (NEW)
    metrics_used: [
      {
        jargon_term: string,  // "route_depth", "success_rate", etc.
        nflfastr_field?: string,  // API field name
        calculation: string,  // How to compute from raw data
        queryable: boolean,  // Can we fetch live data?
        requires_external_data?: string  // If needs non-NFLfastR source
      }
    ],
    
    // Validation
    data_as_of?: string,  // When observation was made
    revalidate_weekly?: boolean,  // Should refresh with live data?
    historical_period?: string  // "2017-2025" if historical comparison
  }
}

SYSTEM 2: JARGON DICTIONARY
File: server/data/nflfastr_jargon_mapping.json
json{
  "route_depth": {
    "nflfastr_field": "air_yards",
    "calculation": "AVG(air_yards) WHERE receiver_player_id = ?",
    "description": "Average distance from LOS where route cut occurs",
    "queryable": true
  },
  
  "route_win_rate": {
    "nflfastr_field": null,
    "external_source": "NextGenStats or FantasyPtsData",
    "description": "Percentage of routes where WR created separation",
    "queryable": false,
    "note": "Not available in NFLfastR - use observation only"
  },
  
  "yards_per_route_run": {
    "nflfastr_field": "receiving_yards",
    "calculation": "SUM(receiving_yards) / routes_run",
    "description": "Efficiency metric independent of target share",
    "queryable": false,
    "requires_external_data": "routes_run (NextGenStats)"
  },
  
  "success_rate": {
    "nflfastr_field": "success",
    "calculation": "COUNT(success=1) / COUNT(*) WHERE rusher_player_id = ? OR receiver_player_id = ?",
    "description": "Play gained required % of yards by down (40% 1st, 60% 2nd, 100% 3rd/4th)",
    "queryable": true
  },
  
  "yards_before_contact": {
    "nflfastr_field": "yards_gained",
    "calculation": "yards_gained - yards_after_contact",
    "description": "Yards gained before first defender contact",
    "queryable": true,
    "note": "yards_after_contact available in NFLfastR"
  },
  
  "red_zone_snap_rate": {
    "nflfastr_field": "yardline_100",
    "calculation": "COUNT(*) WHERE yardline_100 <= 20 AND player_on_field / total_rz_snaps",
    "description": "Percentage of team RZ snaps player was on field",
    "queryable": true
  },
  
  "target_rate_per_route": {
    "nflfastr_field": "targets",
    "calculation": "COUNT(targets) / routes_run",
    "description": "How often QB targets player when they run route",
    "queryable": false,
    "requires_external_data": "routes_run"
  },
  
  "first_downs_per_route_run": {
    "nflfastr_field": "first_down",
    "calculation": "COUNT(first_down=1 AND receiver) / routes_run",
    "description": "Chain-moving efficiency metric",
    "queryable": false,
    "requires_external_data": "routes_run"
  },
  
  "chunk_yardage_rate": {
    "nflfastr_field": "yards_gained",
    "calculation": "COUNT(yards_gained >= threshold) / COUNT(*) WHERE rusher",
    "description": "Percentage of runs hitting yardage thresholds (10+, 15+, 20+, 30+)",
    "queryable": true,
    "thresholds": [10, 15, 20, 30]
  },
  
  "yptpa": {
    "nflfastr_field": "receiving_yards",
    "calculation": "SUM(receiving_yards) / team_pass_attempts",
    "description": "Yards Per Team Pass Attempt - efficiency independent of target share",
    "queryable": true
  },
  
  "dropback_rate_while_trailing": {
    "nflfastr_field": "play_type",
    "calculation": "COUNT(pass=1 AND score_differential < 0) / COUNT(*)",
    "description": "How often team passes when behind (game script indicator)",
    "queryable": true,
    "scope": "team_level"
  },
  
  "target_share_to_rb_te": {
    "nflfastr_field": "targets",
    "calculation": "COUNT(targets WHERE position IN ('RB','TE')) / COUNT(targets)",
    "description": "What % of targets go to RB/TE vs WR",
    "queryable": true,
    "scope": "team_level"
  }
}
Add 10-15 more common metrics as you encounter them in observations.

PATTERN CHUNK EXAMPLES
Example 1: Elite WR Dual-Threshold
json{
  "content": "Elite WR threshold: Route Win Rate above 15% combined with Yards Per Route Run above 2.0. Only 12 receivers hit both marks in 2025, indicating true separation ability + efficiency. Notable: Alec Pierce (17.1% RWR, 2.36 YPRR) crosses into elite territory. JSN's 4.56 YPRR is historically unprecedented - suggests offensive scheme maximizing his skills. Pattern recognition: When receivers cross BOTH thresholds mid-season, it signals sustainable breakout (not just volume spike).",
  
  "metadata": {
    "type": "pattern_observation",
    "pattern_type": "elite_wr_threshold",
    "source": "aggregated_data_analysis",
    "observation_date": "2025-11-11",
    "applicable_to": ["wr"],
    "teaches": "How to identify elite WR performance using dual-threshold system",
    "tags": ["wr_evaluation", "efficiency_metrics", "breakout_indicator"],
    "confidence": "high",
    
    "metrics_used": [
      {
        "jargon_term": "route_win_rate",
        "nflfastr_field": null,
        "calculation": "External source only",
        "queryable": false,
        "requires_external_data": "NextGenStats"
      },
      {
        "jargon_term": "yards_per_route_run",
        "nflfastr_field": "receiving_yards",
        "calculation": "receiving_yards / routes_run",
        "queryable": false,
        "requires_external_data": "routes_run"
      }
    ],
    
    "revalidate_weekly": false,
    "note": "Metrics require external data - use as observation framework only"
  }
}

Example 2: Trailing Dropback Rate (Team Quality)
json{
  "content": "Low dropback rate while trailing is a strong indicator of team quality and positive game script. Teams that rarely pass from behind (bottom 5 in league) are typically elite - they control games and rarely chase points. Fantasy implications: RBs on these teams see consistent volume (no game script abandonment), WRs get quality targets but less garbage time padding, overall offense operates efficiently. Example: Seahawks rank 32nd in trailing dropbacks (11.4%), signaling elite game control. (Pattern identified by Jacob Gibbs @jagibbs_23)",
  
  "metadata": {
    "type": "pattern_observation",
    "pattern_type": "team_quality_indicator",
    "source": "twitter",
    "source_handle": "@jagibbs_23",
    "observation_date": "2025-11-10",
    "applicable_to": ["all_teams", "rb", "wr"],
    "team": "seahawks",
    "teaches": "How to identify positive offensive environments using dropback rate data",
    "tags": ["game_script", "team_quality", "rb_volume", "efficiency_metric"],
    "confidence": "high",
    
    "metrics_used": [
      {
        "jargon_term": "dropback_rate_while_trailing",
        "nflfastr_field": "play_type",
        "calculation": "COUNT(pass=1 AND score_differential < 0) / COUNT(*)",
        "queryable": true
      }
    ],
    
    "revalidate_weekly": true,
    "data_as_of": "2025-11-10"
  }
}

Example 3: Alec Pierce TD Regression
json{
  "content": "Alec Pierce profile is historically unprecedented: Highest average route depth in NFL (2017-present) WHILE maintaining 20% target rate on routes. Typically, deep-route specialists get <10% target rates. Pierce drawing targets at 2x the rate of comparable deep threats. Pattern from historical data: Players combining elite route depth + high target rates inevitably score TDs. Pierce has only 1 TD through 10 weeks despite perfect profile. Regression to mean = 'gobs of touchdowns' incoming. Trust the process when usage profile is elite but TDs lag.",
  
  "metadata": {
    "type": "player_insight",
    "pattern_type": "td_positive_regression",
    "source": "aggregated_data_analysis",
    "observation_date": "2025-11-11",
    "player_id": "alec_pierce",
    "position": "wr",
    "applicable_to": ["wr"],
    "teaches": "How to identify TD regression candidates using route depth + target rate combination",
    "tags": ["td_upside", "deep_threat", "positive_regression", "historical_anomaly"],
    "confidence": "high",
    "historical_period": "2017-2025",
    
    "metrics_used": [
      {
        "jargon_term": "route_depth",
        "nflfastr_field": "air_yards",
        "calculation": "AVG(air_yards) WHERE receiver_player_name = 'A.Pierce'",
        "queryable": true
      },
      {
        "jargon_term": "target_rate_per_route",
        "nflfastr_field": "targets",
        "calculation": "COUNT(targets) / routes_run",
        "queryable": false,
        "requires_external_data": "routes_run"
      }
    ],
    
    "revalidate_weekly": true,
    "data_as_of": "2025-11-11"
  }
}

Example 4: RB Explosiveness (Achane)
json{
  "content": "RB explosiveness evaluation: Track percentage of runs hitting chunk yardage thresholds (10+, 15+, 20+, 30+ yards). Elite backs rank top 3 in multiple tiers. De'Von Achane 2025: 16.1% (10+ yards), 9.1% (15+), 5.6% (20+), 2.8% (30+) - elite across all thresholds. This explosiveness profile signals league-winning upside despite potential volume concerns. When evaluating RBs, prioritize multi-tier explosiveness over raw volume - big plays win weeks.",
  
  "metadata": {
    "type": "pattern_observation",
    "pattern_type": "rb_explosiveness_evaluation",
    "source": "aggregated_data_analysis",
    "observation_date": "2025-11-11",
    "player_example": "devon_achane",
    "position": "rb",
    "applicable_to": ["rb"],
    "teaches": "How to identify RBs with league-winning ceiling using chunk yardage rates",
    "tags": ["rb_evaluation", "explosiveness", "upside_indicator", "big_play_ability"],
    "confidence": "high",
    
    "metrics_used": [
      {
        "jargon_term": "chunk_yardage_rate",
        "nflfastr_field": "yards_gained",
        "calculation": "COUNT(yards_gained >= [10,15,20,30]) / COUNT(*) WHERE rusher_player_id = ?",
        "queryable": true
      }
    ],
    
    "revalidate_weekly": true,
    "data_as_of": "2025-11-11"
  }
}

Example 5: Efficiency Predicts Volume (Jaylin Noel)
json{
  "content": "First Downs Per Route Run (1D/RR) identifies efficient receivers before volume arrives. Jaylin Noel post-bye: 0.154 1D/RR, 2.69 YPRR - comparable to Puka Nacua's legendary rookie efficiency (0.126 1D/RR, 2.75 YPRR). Pattern recognition: When low-volume receivers match elite efficiency benchmarks, they're earning trust. Volume typically follows 2-4 weeks later as coaches recognize chain-moving ability. Noel running 9 fewer routes than Kirk but leading team in 1D/RR = opportunity coming.",
  
  "metadata": {
    "type": "breakout_indicator",
    "pattern_type": "efficiency_precedes_volume",
    "source": "aggregated_data_analysis",
    "observation_date": "2025-11-11",
    "player_example": "jaylin_noel",
    "benchmark_player": "puka_nacua",
    "position": "wr",
    "applicable_to": ["wr"],
    "teaches": "How to spot volume increases before they happen using efficiency metrics",
    "tags": ["efficiency_metrics", "volume_predictor", "chain_moving", "trust_building", "breakout_indicator"],
    "confidence": "medium",
    
    "metrics_used": [
      {
        "jargon_term": "first_downs_per_route_run",
        "nflfastr_field": "first_down",
        "calculation": "COUNT(first_down=1 AND receiver) / routes_run",
        "queryable": false,
        "requires_external_data": "routes_run"
      },
      {
        "jargon_term": "yards_per_route_run",
        "nflfastr_field": "receiving_yards",
        "calculation": "receiving_yards / routes_run",
        "queryable": false,
        "requires_external_data": "routes_run"
      }
    ],
    
    "revalidate_weekly": true,
    "data_as_of": "2025-11-11"
  }
}

Example 6: RB Success Rate with YBIC
json{
  "content": "RB talent evaluation: Success rate on runs with 1+ yard before contact isolates vision/decision-making from O-line quality. Elite tier (75%+ success rate) includes Dobbins, Jeanty, Williams, Taylor, Cook, Henry, Robinson - all maximizing created opportunities. Pattern: RBs in this tier have league-winning upside even with volume concerns, because they convert opportunity efficiently. When evaluating RBs, prioritize success rate with YBIC over raw volume - measures 'what they do with the chances they get.'",
  
  "metadata": {
    "type": "talent_evaluation",
    "pattern_type": "rb_efficiency_independent_of_line",
    "source": "aggregated_data_analysis",
    "observation_date": "2025-11-11",
    "position": "rb",
    "applicable_to": ["rb"],
    "teaches": "How to evaluate RB talent independent of offensive line quality",
    "tags": ["rb_evaluation", "vision", "decision_making", "efficiency", "talent_indicator"],
    "confidence": "high",
    
    "metrics_used": [
      {
        "jargon_term": "success_rate",
        "nflfastr_field": "success",
        "calculation": "COUNT(success=1) / COUNT(*) WHERE rusher_player_id = ? AND yards_before_contact >= 1",
        "queryable": true
      },
      {
        "jargon_term": "yards_before_contact",
        "nflfastr_field": "yards_gained",
        "calculation": "yards_gained - yards_after_contact",
        "queryable": true
      }
    ],
    
    "revalidate_weekly": true,
    "threshold": "75%",
    "data_as_of": "2025-11-11"
  }
}

SYSTEM 3: DATA VALIDATION SERVICE
File: server/services/nflfastrValidation.ts
typescriptimport { jargonMapping } from '../data/nflfastr_jargon_mapping.json';

interface ValidationRequest {
  jargon_term: string;
  player_id?: string;
  team?: string;
  season: number;
}

interface ValidationResult {
  metric: string;
  value: number;
  queryable: boolean;
  data_as_of: string;
  calculation_used: string;
}

/**
 * Validates observation metrics against live NFLfastR data
 */
export async function validateMetric(request: ValidationRequest): Promise<ValidationResult> {
  const mapping = jargonMapping[request.jargon_term];
  
  if (!mapping) {
    throw new Error(`Unknown jargon term: ${request.jargon_term}`);
  }
  
  if (!mapping.queryable) {
    return {
      metric: request.jargon_term,
      value: null,
      queryable: false,
      data_as_of: null,
      calculation_used: mapping.description
    };
  }
  
  // Build query based on mapping
  const query = buildNFLfastRQuery(mapping, request);
  
  // Execute query (you'll need to implement actual NFLfastR query logic)
  const result = await queryNFLfastR(query);
  
  return {
    metric: request.jargon_term,
    value: result.value,
    queryable: true,
    data_as_of: new Date().toISOString(),
    calculation_used: mapping.calculation
  };
}

/**
 * Enriches pattern chunks with live data when queryable metrics present
 */
export async function enrichChunkWithLiveData(chunk: any, playerId?: string): Promise<any> {
  const queryableMetrics = chunk.metadata.metrics_used?.filter(m => m.queryable) || [];
  
  if (queryableMetrics.length === 0) {
    return chunk; // No queryable metrics, return as-is
  }
  
  const liveData = await Promise.all(
    queryableMetrics.map(metric => 
      validateMetric({
        jargon_term: metric.jargon_term,
        player_id: playerId || chunk.metadata.player_id,
        season: 2025
      })
    )
  );
  
  return {
    ...chunk,
    live_data: liveData
  };
}

INTEGRATION WITH RAG CHAT
Update: POST /api/rag/chat endpoint
typescript// After retrieving chunks via semantic search
const relevantChunks = await searchChunks(userQuery);

// Enrich chunks with live data if player mentioned
if (playerMentioned) {
  const enrichedChunks = await Promise.all(
    relevantChunks.map(chunk => enrichChunkWithLiveData(chunk, playerId))
  );
  
  // Build prompt with live data
  const promptContext = enrichedChunks.map(chunk => {
    let context = chunk.content;
    
    if (chunk.live_data && chunk.live_data.length > 0) {
      context += "\n\nLive Data Validation:\n";
      chunk.live_data.forEach(data => {
        context += `- ${data.metric}: ${data.value} (as of ${data.data_as_of})\n`;
      });
    }
    
    return context;
  }).join('\n\n');
  
  // Generate response with Gemini including live data context
  const response = await generateResponse(promptContext, userQuery);
}

IMPLEMENTATION TASKS
Priority 1: Foundation (Do First)

✅ Create nflfastr_jargon_mapping.json with 20+ common metrics
✅ Update chunks schema to include metrics_used array
✅ Create seed script to embed the 6 example pattern chunks above

Priority 2: Data Integration (Do Second)

✅ Build nflfastrValidation.ts service
✅ Implement validateMetric() function (queries NFLfastR)
✅ Implement enrichChunkWithLiveData() function

Priority 3: RAG Enhancement (Do Third)

✅ Update /api/rag/chat to detect queryable metrics in chunks
✅ Fetch live data when available
✅ Include live data in prompt context for Gemini
✅ Test: User asks about Pierce → TIBER cites live route depth data

Priority 4: Content Scaling (Ongoing)

✅ Add more pattern observation chunks as you find good X posts
✅ Maintain legal compliance (attribution, paraphrasing)
✅ Keep jargon dictionary updated as new metrics emerge


LEGAL COMPLIANCE REMINDERS
✅ DO:

Paraphrase insights in your own words
Attribute sources (Twitter handle, date)
Link to original posts in metadata
Use facts/stats (not copyrightable)
Frame as "pattern teaching" not "data republishing"

❌ DON'T:

Copy entire threads verbatim
Use proprietary data (FantasyPtsData) without permission
Claim others' analysis as TIBER's original work
Republish data tables from paid services

When in doubt: Use the PATTERN (how to evaluate) not the DATA (exact numbers for all players).

TESTING CHECKLIST
After implementation, test:

Pattern Retrieval: Search "explosive running backs" → retrieves Achane chunk
Live Data Enhancement: Ask about Pierce → TIBER cites current route depth from NFLfastR
Attribution: Check that Twitter sources are preserved in responses
Non-Queryable Metrics: Chunks with external-only metrics still work (just don't fetch live data)
Weekly Revalidation: Chunks marked revalidate_weekly: true get fresh data