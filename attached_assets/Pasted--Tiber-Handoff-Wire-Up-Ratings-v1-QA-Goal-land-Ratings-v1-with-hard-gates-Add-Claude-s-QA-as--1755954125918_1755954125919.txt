ðŸ“¦ Tiber Handoff â€” Wire Up Ratings v1 QA

Goal: land Ratings v1 with hard gates. Add Claudeâ€™s QA as a runnable suite + PR checks. No regressions sneak through.

1) Drop the docs (for humans)

Create: docs/QA/ratings_v1_checklist.md

Paste Claudeâ€™s full checklist there (parts 1 & 2 he sent).

2) Add a runnable regression script (for machines)

Create: scripts/qa/ratings_regression_test.sh

#!/usr/bin/env bash
set -euo pipefail

BASE_URL="${BASE_URL:-http://localhost:3000}"

echo "[QA] Ratings API health"
curl -sf "$BASE_URL/api/ratings?format=redraft&position=RB&season=2024&week=6&limit=25" > /dev/null
curl -sf "$BASE_URL/api/ratings?format=dynasty&position=WR&season=2024&limit=50" > /dev/null
curl -sf "$BASE_URL/api/ratings?format=redraft&position=QB&season=2024&week=17&debug=1" | jq -e '.items' > /dev/null

echo "[QA] Param validation"
curl -s "$BASE_URL/api/ratings?format=INVALID&position=RB&season=2024" | grep -qi "error" || (echo "Expected error for invalid format" && exit 1)
curl -s "$BASE_URL/api/ratings?format=redraft&position=INVALID&season=2024" | grep -qi "error" || (echo "Expected error for invalid position" && exit 1)
curl -s "$BASE_URL/api/ratings?format=redraft&position=RB&season=2024&week=0" | grep -qi "error" || (echo "Expected error for week=0" && exit 1)
curl -s "$BASE_URL/api/ratings?format=redraft&position=RB&season=2024&week=18" | grep -qi "error" || (echo "Expected error for week=18 in 2024" && exit 1)

echo "[QA] Tiers endpoint"
curl -sf "$BASE_URL/api/ratings/tiers?format=redraft&position=RB&season=2024&week=6" | jq -e '.tiers' > /dev/null

echo "[QA] Weight override sanity"
curl -sf "$BASE_URL/api/ratings?format=redraft&position=RB&season=2024&week=6&weights=0.4,0.3,0.15,0.1,0.03,0.02" > /dev/null

echo "[QA] DONE"


Windows convenience: scripts/qa/ratings_regression_test.ps1

$BASE_URL = $env:BASE_URL
if (-not $BASE_URL) { $BASE_URL = "http://localhost:3000" }

Write-Host "[QA] Ratings API health"
iwr "$BASE_URL/api/ratings?format=redraft&position=RB&season=2024&week=6&limit=25" -UseBasicParsing | Out-Null
iwr "$BASE_URL/api/ratings?format=dynasty&position=WR&season=2024&limit=50" -UseBasicParsing | Out-Null
(iwr "$BASE_URL/api/ratings?format=redraft&position=QB&season=2024&week=17&debug=1" -UseBasicParsing).Content | ConvertFrom-Json | Select-Object -Expand items | Out-Null

Write-Host "[QA] Param validation"
$resp = (iwr "$BASE_URL/api/ratings?format=INVALID&position=RB&season=2024" -UseBasicParsing).Content
if ($resp -notmatch "error") { throw "Expected error for invalid format" }

$resp = (iwr "$BASE_URL/api/ratings?format=redraft&position=INVALID&season=2024" -UseBasicParsing).Content
if ($resp -notmatch "error") { throw "Expected error for invalid position" }

$resp = (iwr "$BASE_URL/api/ratings?format=redraft&position=RB&season=2024&week=0" -UseBasicParsing).Content
if ($resp -notmatch "error") { throw "Expected error for week=0" }

$resp = (iwr "$BASE_URL/api/ratings?format=redraft&position=RB&season=2024&week=18" -UseBasicParsing).Content
if ($resp -notmatch "error") { throw "Expected error for week=18 in 2024" }

Write-Host "[QA] Tiers endpoint"
(iwr "$BASE_URL/api/ratings/tiers?format=redraft&position=RB&season=2024&week=6" -UseBasicParsing).Content | ConvertFrom-Json | Select-Object -Expand tiers | Out-Null

Write-Host "[QA] Weight override sanity"
iwr "$BASE_URL/api/ratings?format=redraft&position=RB&season=2024&week=6&weights=0.4,0.3,0.15,0.1,0.03,0.02" -UseBasicParsing | Out-Null

Write-Host "[QA] DONE"


package.json

{
  "scripts": {
    "qa:ratings": "bash scripts/qa/ratings_regression_test.sh"
  }
}

3) Parameter guards (align controller with QA)

Patch your controller before running QA:

const VALID_POS = new Set(["QB","RB","WR","TE"]);
const VALID_FMT = new Set(["redraft","dynasty"]);

function maxWeekForSeason(season: number) {
  return season === 2024 ? 17 : 18; // extend as needed
}

function bad(res, msg: string) { return res.status(400).json({ error: msg }); }

// in getRatings():
if (!VALID_FMT.has(format)) return bad(res, "invalid format");
if (!VALID_POS.has(position)) return bad(res, "invalid position");
if (format === "redraft") {
  if (!week) return bad(res, "week required for redraft");
  const maxWeek = maxWeekForSeason(season);
  if (week < 1 || week > maxWeek) return bad(res, `week must be 1..${maxWeek} for season ${season}`);
}

// weights parsing: ensure correct count per position/format or normalize/fallback.

4) CI gate (PRs must pass QA)

.github/workflows/ci-qa-ratings.yml

name: Ratings QA
on:
  pull_request:
    paths:
      - 'server/src/modules/ratings/**'
      - 'server/src/db/migrations/**'
      - 'docs/QA/**'
      - 'scripts/qa/**'
jobs:
  qa:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: otc
        ports: ['5432:5432']
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20' }
      - name: Install
        run: npm ci
      - name: Migrate + seed (minimal)
        run: |
          npm run db:migrate
          node scripts/seed/minimal_ratings_seed.js
      - name: Start API
        run: |
          BASE_URL=http://localhost:3000
          npm run start & sleep 5
      - name: Run QA
        env:
          BASE_URL: http://localhost:3000
        run: bash scripts/qa/ratings_regression_test.sh


(Have a tiny scripts/seed/minimal_ratings_seed.js that inserts a handful of player_profile, a couple weeks of player_inputs, runs compute once so the QA can hit live endpoints.)

5) DB smoke checks (manual)

Run these once locally:

SELECT COUNT(*) FROM player_inputs  WHERE season=2024;        -- thousands
SELECT COUNT(*) FROM player_profile;                          -- hundreds+
SELECT COUNT(*) FROM player_scores WHERE season=2024;         -- populated post compute

6) Go/No-Go gates (must be âœ… before merging)

/api/ratings returns data for redraft (weeked) and dynasty (seasonal).

Parameter validation returns 400 on bad format, position, week.

debug=1 shows component breakdown and aligns with weights.

VOR uses RB40/WR48/TE16/QB12.

/api/ratings/tiers returns sane buckets (no single-player Tier 1 unless deserved).

QA script passes locally and in CI.

Paste-ready message to Tiber

Ratings v1 â€“ QA Integration

Add docs/QA/ratings_v1_checklist.md (Claudeâ€™s doc).

Create runnable QA scripts at scripts/qa/ratings_regression_test.sh (+ optional .ps1).

Add npm run qa:ratings.

Tighten controller param guards (format/position/week-by-season).

Add CI workflow ci-qa-ratings.yml that spins DB â†’ migrates â†’ seeds minimal data â†’ boots API â†’ runs QA.

Ensure VOR replacement levels and weight overrides behave as in docs.

Definition of Done: CI QA green + manual smoke SQL counts above.

Ping when green; then we move to UI v2.