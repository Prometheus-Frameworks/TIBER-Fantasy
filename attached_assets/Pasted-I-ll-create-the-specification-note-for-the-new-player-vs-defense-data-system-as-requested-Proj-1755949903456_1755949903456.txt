I'll create the specification note for the new player-vs-defense data system as requested.

# Project 2024 - Player vs Defense Data Specification

## Overview
The system now exposes per-player fantasy game performance against specific defenses to support two key features:
1. Strength of Schedule (SOS) weekly "Samples" panel
2. Leaders widgets (top single-game performances and points allowed by defense)

## Data Structure

### Source Table: player_vs_defense
```sql
CREATE TABLE IF NOT EXISTS player_vs_defense (
  id SERIAL PRIMARY KEY,
  season SMALLINT NOT NULL,
  week SMALLINT NOT NULL,
  def_team TEXT NOT NULL,          -- Defense team code (e.g., 'NO')
  position TEXT NOT NULL,           -- Player position (RB/WR/TE/QB)
  player_id TEXT,                   -- Unique player identifier
  player_name TEXT NOT NULL,        -- Player name
  player_team TEXT,                 -- Player's team code
  fpts NUMERIC NOT NULL,            -- Fantasy points scored (PPR default)
  UNIQUE(season, week, def_team, position, player_name)
);
```

### Indexing for Performance
```sql
CREATE INDEX IF NOT EXISTS idx_pvd_q ON player_vs_defense(season, week, def_team, position);
CREATE INDEX IF NOT EXISTS idx_pvd_player ON player_vs_defense(player_id, season);
CREATE INDEX IF NOT EXISTS idx_pvd_def_team ON player_vs_defense(def_team, position, season);
```

## Data Generation Process

### Ingestion Script
- **Script**: `scripts/ingest_player_vs_defense.py`
- **Source**: nfl_data_py weekly data (2024 Weeks 1-17)
- **Scoring**: PPR scoring by default (standard scoring available later via toggle)
- **Command**: `python scripts/ingest_player_vs_defense.py --year=2024 --weeks=1-17 --ppr`

### Output File
- **Format**: CSV with header row
- **Columns**: season, week, def_team, position, player_name, player_team, fpts, player_id
- **Validation**: Multi-thousand rows expected for 2024 season (all positions, 17 weeks)

## API Endpoints

### 1. Weekly Top Performers
```
GET /api/leaders/weekly?season=2024&week=6&position=RB&limit=25
```
Returns top single-game performances for a specific week and position.

### 2. Points Allowed by Defense
```
GET /api/leaders/allowed?season=2024&week=6&position=RB
```
Returns total fantasy points allowed by each defense for a specific week and position.

### 3. SOS Samples Integration
The SOS weekly endpoint includes samples from this data:
```
GET /api/sos/weekly?season=2024&week=6&position=RB&mode=ctx&samples=5
```
Response includes:
```json
{
  "samples": {
    "total": 54.2,
    "players": [
      {"name": "Sean Tucker", "team": "TB", "fpts": 35.2},
      {"name": "Bucky Irving", "team": "TB", "fpts": 19.0}
    ]
  }
}
```

## Feature Integration

### 1. SOS "Samples" Panel
- Displays actual player performances against a specific defense
- Helps users understand the context behind SOS ratings
- Links directly to player profiles and defense details

### 2. Leaders Widgets
- **Top Single-Game Performances**: Shows best individual performances by week and position
- **Points Allowed by Defense**: Ranks defenses by fantasy points allowed to a position
- Both widgets include team logos and link back to SOS context

## Assumptions & Defaults

1. **Scoring System**: PPR scoring is the default implementation
2. **Data Scope**: 2024 regular season (Weeks 1-17) initially
3. **Position Coverage**: RB, WR, TE, QB all included
4. **Team Codes**: Standard NFL team abbreviations used throughout
5. **Future Expansion**: Support for standard scoring via parameter toggle planned

## Data Relationships
```
player_vs_defense → SOS Samples: def_team = opponent, position matches
player_vs_defense → Leaders: Weekly top performances by position
player_vs_defense → Defense Rankings: SUM(fpts) grouped by def_team
```

This specification ensures consistent implementation across the SOS and Leaders features while maintaining data integrity and performance.