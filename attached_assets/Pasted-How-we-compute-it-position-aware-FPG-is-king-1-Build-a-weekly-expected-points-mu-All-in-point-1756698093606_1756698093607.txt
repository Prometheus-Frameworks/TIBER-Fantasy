How we compute it (position-aware, FPG is king)
1) Build a weekly expected points “mu”

All in points, not z-scores. FPG drives.

mu = 0.50 * xFPG_now_pts          // EWMA(3w) expected from usage (forward)
   + 0.35 * projFPG_pts           // external projections (market sanity)
   + 0.15 * Form_FPG_pts          // recent truth (EWMA 3w)
mu = mu * OppMultiplier * AvailFactor


OppMultiplier: 0.85–1.15 from your SOS hook (vs position).

AvailFactor: 0.85–1.00 from practice trend / pitch count.

(You already have all three signals wired.)

2) Estimate variance (sigma) for floor/ceiling

Cheap, robust proxies (normalized 0–1, then scale by position spread):

risk = 0.40 * RoleVolatility      // stddev of snaps/routes/attempts (3w)
     + 0.20 * TeamVolatility      // pace/PROE swings (OASIS)
     + 0.20 * InjuryRisk          // Q tag trend / recent DNP
     + 0.20 * QBStabilityPenalty  // for WR/TE when QB changed

sigma_pts = risk * PosSpread      // QB:5, RB:6, WR:7, TE:5 (empirical)
floor = mu - 1.0 * sigma_pts
ceil  = mu + 1.0 * sigma_pts


Use 1.0 as k for floor/ceiling to stay conservative. Bump to 1.5 if you want wider ranges.

3) Upside bias (your twist, especially for rushing QBs)

Let high-upside profiles push rag_score, not mu (so we don’t fake points):

upside_boost_pts = min(4, 8 * UpsideIndex/100 * (0.4 + 0.6*max(0, BeatProj0_100)/100))


Max +4 pts into rag_score (not mu).

Rookies get full credit; vets get 60% (same logic you approved earlier).

4) Convert to rag_score (0–100) + color

Make it league-relative per position this week so it auto-calibrates:

z = (mu - PosMedianPts) / PosStdPts
base_score = clamp01( 0.5 + 0.2 * z ) * 100            // gentle slope
rag_score  = clamp(0, 100, base_score + upside_boost_pts)

Color rules (per position this week):
- GREEN  if rag_score ≥ 66   OR floor ≥ PosP40
- AMBER  if 40 ≤ rag_score < 66
- RED    if rag_score < 40   OR OUT/Doubtful


Thresholds are dynamic because they reference this week’s distribution for that position (from projections/xFPG). Foolproof: a 15-pt TE can be Green while a 15-pt WR might be Amber.

Integration points (concrete and simple)
DB: you already extended facts; nothing else required

We’ll add the computed outputs:

expected_points (mu)

floor_points, ceiling_points

rag_score (0–100)

rag_color (“GREEN”|“AMBER”|“RED”)

Nightly job (add 1 function call)

After buildFactsForWeek and before you compute PowerScore:

// src/jobs/nightlyRecalc.ts (inside player loop, after advanced fields exist)
import { computeRAG } from '../core/rag.js';

const posStats = await getPositionDistribution(season, week, player.position); // median/std & P40
const oppMult  = getOppMultiplier(player.team, player.position);
const avail    = getAvailabilityFactor(player_id);

const rag = computeRAG({
  pos: player.position,
  xfpg_pts: facts.xfpg,           // EWMA(3w) expected points
  proj_pts: facts.proj_fpg,
  form_pts: facts.fpg,            // EWMA(3w) recent truth
  oppMultiplier: oppMult,
  availability: avail,
  roleVolatility: facts.role_vol, // 0..1
  teamVolatility: facts.team_vol, // 0..1
  injuryRisk: facts.injury_risk,  // 0..1
  qbStabilityPenalty: facts.qb_penalty, // 0..1
  upsideIndex: facts.upside_index,      // 0..100
  beatProj0_100: facts.beat_proj,       // 0..100
  posMedianPts: posStats.median,
  posStdPts: posStats.std,
  posP40: posStats.p40
});

// persist rag + expected/floor/ceiling
await q(`
  update player_week_facts
  set expected_points=$1, floor_points=$2, ceiling_points=$3,
      rag_score=$4, rag_color=$5
  where player_id=$6 and season=$7 and week=$8
`, [rag.mu, rag.floor, rag.ceiling, rag.score, rag.color, player_id, season, week]);

computeRAG (drop-in)
// src/core/rag.ts
export function computeRAG(i: {
  pos: 'QB'|'RB'|'WR'|'TE',
  xfpg_pts: number, proj_pts: number, form_pts: number,
  oppMultiplier: number, availability: number,
  roleVolatility: number, teamVolatility: number,
  injuryRisk: number, qbStabilityPenalty: number,
  upsideIndex: number, beatProj0_100: number,
  posMedianPts: number, posStdPts: number, posP40: number
}) {
  const mu = (0.50*i.xfpg_pts + 0.35*i.proj_pts + 0.15*i.form_pts) * i.oppMultiplier * i.availability;

  const posSpread = i.pos==='QB' ? 5 : i.pos==='RB' ? 6 : i.pos==='WR' ? 7 : 5;
  const risk = 0.40*i.roleVolatility + 0.20*i.teamVolatility + 0.20*i.injuryRisk + 0.20*i.qbStabilityPenalty;
  const sigma = risk * posSpread;

  const floor = mu - 1.0*sigma;
  const ceiling = mu + 1.0*sigma;

  const z = (mu - i.posMedianPts) / (i.posStdPts || 1);
  const baseScore = Math.max(0, Math.min(100, (0.5 + 0.2*z) * 100));

  const upsideBoost = Math.min(4, 8 * (i.upsideIndex/100) * (0.4 + 0.6*Math.max(0, i.beatProj0_100)/100));
  const score = Math.max(0, Math.min(100, baseScore + upsideBoost));

  const color = (score >= 66 || floor >= i.posP40) ? 'GREEN'
              : (score >= 40) ? 'AMBER' : 'RED';

  return { mu, floor, ceiling, score, color };
}

API: add RAG fields so users can act

Augment /api/power/:type items with:

"expected_points": 16.8,
"floor_points": 12.1,
"ceiling_points": 21.4,
"rag_score": 73,
"rag_color": "GREEN"


…and keep a short reasons array for the UI:

“Rushing QB (+upside)”

“Beating projections”

“Bad pass D matchup”

“Pitch count risk”

(Just map booleans from inputs to text; no need for an LLM.)

Validation targets (so we trust the colors)

Calibration: Among GREENs, average next-week points should be ≥ AMBER ≥ RED.

Precision: GREEN Top-X hit rate (per position) ≥ AMBER ≥ RED.

Brier-style: If you later bucket GREEN into strong/weak, measure hit probabilities vs outcomes.

Guardrail: If a player is OUT, force RED regardless of score.

How this helps your “we favor upside” thesis

Rushing QBs (Maye/JJM) get GREEN faster because upside_boost lifts their rag_score even if raw mu is modest early.

If they fail to beat projections, the boost shrinks, and they naturally slide to AMBER without whiplash.

FPG remains king: mu is points-based and opponent/availability aware.

TL;DR

Compute expected points (mu) from xFPG/proj/FPG, adjust for opponent + availability.

Estimate floor/ceiling from role/team/injury volatility.

Add a controlled upside boost (rushing QBs shine).

Convert to rag_score + color per position distribution each week.

Return it via API so the UI can show GREEN/AMBER/RED + reasons.