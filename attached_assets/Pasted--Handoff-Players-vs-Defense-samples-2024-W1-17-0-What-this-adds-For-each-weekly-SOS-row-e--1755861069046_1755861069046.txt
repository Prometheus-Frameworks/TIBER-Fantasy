üì¶ Handoff: ‚ÄúPlayers vs Defense‚Äù samples (2024 W1‚Äì17)
0) What this adds

For each weekly SOS row (e.g., TB @ NO, Week 6, RB), show:

Total RB points vs NO that week (sum of all RBs)

Top 3 scorers: player, team, FPTS

(Optional later: toggle PPR vs Standard)

1) DB: new table for per-player samples

Migration server/src/db/migrations/20250822_add_player_vs_defense.sql

CREATE TABLE IF NOT EXISTS player_vs_defense (
  id SERIAL PRIMARY KEY,
  season SMALLINT NOT NULL,
  week SMALLINT NOT NULL,
  def_team TEXT NOT NULL,        -- opponent_team (the defense)
  position TEXT NOT NULL,        -- QB/RB/WR/TE
  player_id TEXT,                -- gsis_id or pfr_id if available
  player_name TEXT NOT NULL,
  player_team TEXT,              -- player‚Äôs NFL team that week
  fpts NUMERIC NOT NULL,         -- fantasy points (PPR by default)
  UNIQUE(season, week, def_team, position, player_name)
);

CREATE INDEX IF NOT EXISTS idx_pvd_q ON player_vs_defense(season, week, def_team, position);

2) Ingest script (batched, uses nfl_data_py)

File scripts/ingest_player_vs_defense.py

import nfl_data_py as nfl
import pandas as pd
import argparse
from pathlib import Path

def parse_weeks(arg):
    if "-" in arg:
        a,b = arg.split("-")
        return list(range(int(a), int(b)+1))
    return [int(w) for w in arg.split(",")]

def main(year=2024, weeks_str="1-17", ppr=True, outdir="data"):
    weeks = parse_weeks(weeks_str)
    positions = ["QB","RB","WR","TE"]
    fp_col = "fantasy_points_ppr" if ppr else "fantasy_points"

    out_path = Path(outdir) / f"player_vs_defense_{year}.csv"
    out_path.parent.mkdir(parents=True, exist_ok=True)

    wrote = False
    for wk in weeks:
        df = nfl.import_weekly_data([year])
        df = df[(df["season"]==year) & (df["season_type"]=="REG") & (df["week"]==wk)]
        df = df[df["position"].isin(positions)]

        keep = df[[
            "season","week","opponent_team","position","player_name","recent_team",fp_col,"player_id"
        ]].rename(columns={
            "opponent_team":"def_team",
            "recent_team":"player_team",
            fp_col:"fpts"
        })

        # Drop rows with missing name or fpts
        keep = keep[keep["player_name"].notna() & keep["fpts"].notna()]

        mode = "w" if not wrote else "a"
        keep.to_csv(out_path, index=False, mode=mode, header=(not wrote))
        wrote = True
        print(f"Wrote week {wk}: {len(keep)} rows")

    print(f"OK: {out_path} generated")

if __name__ == "__main__":
    p = argparse.ArgumentParser()
    p.add_argument("--year", type=int, default=2024)
    p.add_argument("--weeks", type=str, default="1-17")
    p.add_argument("--ppr", action="store_true")  # default False -> use --ppr to enable PPR
    p.add_argument("--outdir", type=str, default="data")
    args = p.parse_args()
    main(year=args.year, weeks_str=args.weeks, ppr=args.ppr, outdir=args.outdir)


Run (same env as other ingests):

python scripts/ingest_player_vs_defense.py --year=2024 --weeks=1-17 --ppr


Load:

\COPY player_vs_defense(season,week,def_team,position,player_name,player_team,fpts,player_id)
FROM 'data/player_vs_defense_2024.csv' CSV HEADER;

3) Backend: add samples to weekly endpoint

In server/src/modules/sos/sos.service.ts (or wherever the weekly list is assembled), after you compute each row, if req.query.samples is passed (e.g., samples=3), fetch the top players:

// pseudo/TS snippet inside the loop per row:
if (samples > 0) {
  const players = await db
    .selectFrom('player_vs_defense')
    .select(['player_name','player_team','fpts'])
    .where('season','=',season)
    .where('week','=',week)
    .where('def_team','=',row.opponent)       // opponent defense
    .where('position','=',position)
    .orderBy('fpts','desc')
    .limit(samples)
    .execute();

  const totalRow = await db
    .selectFrom('player_vs_defense')
    .select(db.fn.sum('fpts').as('total_fpts'))
    .where('season','=',season)
    .where('week','=',week)
    .where('def_team','=',row.opponent)
    .where('position','=',position)
    .executeTakeFirst();

  row.samples = {
    total: Number(totalRow?.total_fpts ?? 0),
    players: players.map(p => ({
      name: p.player_name,
      team: p.player_team,
      fpts: Number(p.fpts)
    }))
  };
}


Controller: parse samples (default 0):

const samples = Math.max(0, parseInt((req.query.samples as string) || '0', 10));
// pass samples into service


Response example (samples=3)

{
  "team": "TB",
  "opponent": "NO",
  "score": 63,
  "tier": "yellow",
  "samples": {
    "total": 54.2,
    "players": [
      { "name": "Sean Tucker", "team": "TB", "fpts": 35.2 },
      { "name": "Bucky Irving", "team": "TB", "fpts": 19.0 },
      { "name": "Some RB", "team": "TB", "fpts": 0.0 }
    ]
  }
}


We won‚Äôt list ‚ÄúDNP‚Äù ‚Äî we only show actual scorers. (If you really want DNP flags later, we can add an ‚ÄúActive list‚Äù cross-reference, but it‚Äôs overkill for now.)

4) UI: expand row to show samples (with logos)

In web/src/components/SOSTable.tsx (or your table component):

Add an ‚Äúexpand‚Äù chevron per row that fetches ?samples=3 (or include samples in the main call).

Render a sub-row showing Total position points vs defense and the Top 3 list.

Snippet (conceptual diff):

// inside row render
<td className="px-3 py-2">
  <button onClick={() => toggleExpanded(row.team)} className="text-sm underline">Samples</button>
</td>

{expanded[row.team] && row.samples && (
  <tr className="bg-gray-50">
    <td colSpan={999} className="px-6 py-3">
      <div className="flex items-center gap-4 mb-2">
        <span className="text-sm font-semibold">Total {position} FPTS vs {row.opponent}:</span>
        <span className="text-base font-bold">{Math.round(row.samples.total*10)/10}</span>
      </div>
      <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
        {row.samples.players.map((p) => (
          <div key={p.name} className="flex items-center gap-2 border rounded px-3 py-2">
            <TeamLogo team={p.team} size={18} />
            <div className="text-sm">
              <div className="font-medium">{p.name}</div>
              <div className="text-xs text-gray-600">{p.team}</div>
            </div>
            <div className="ml-auto font-semibold">{p.fpts.toFixed(1)}</div>
          </div>
        ))}
      </div>
    </td>
  </tr>
)}


If you‚Äôd rather not add a second fetch on expand, just include samples=3 in the main /weekly call and render immediately.

5) Test drives (copy-paste)

API

/api/sos/weekly?position=RB&week=6&season=2024&mode=ctx&samples=3&debug=1


UI

Go to /sos, Season=2024, Week=6, Position=RB, Mode=Contextual, Debug=ON.

Click Samples on the TB @ NO row. You‚Äôll see Total RB FPTS vs NO and the Top 3.

6) Definition of Done

 New table player_vs_defense loaded for 2024 W1‚Äì17.

 /api/sos/weekly supports samples=N and returns samples.total + samples.players.

 Table UI can show an expanded ‚ÄúSamples‚Äù section per row with logos.

 No change to existing SOS scoring ‚Äî this is purely QOL context.