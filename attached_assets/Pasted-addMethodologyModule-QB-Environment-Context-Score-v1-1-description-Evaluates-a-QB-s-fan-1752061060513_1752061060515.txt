addMethodologyModule("QB Environment & Context Score (v1.1)", {
  description: "Evaluates a QBâ€™s fantasy upside based on rushing, accuracy, protection, and surrounding weapons.",
  triggerScope: ["dynastyValuation", "playerProfile", "environmentScan"],
  inputValidation: {
    requiredFields: [
      "player.season",
      "player.position",
      "player.scrambleRate",
      "player.rushYPG",
      "player.yardsPerCarry",
      "player.explosiveRushRate",
      "player.cpoe",
      "player.adjustedCompletionPct",
      "player.deepAccuracyRate",
      "player.pressureToSackRate",
      "team.passBlockGrade",
      "team.passBlockWinRate",
      "team.pressureRateAllowed",
      "team.pressureRateOverExpected",
      "team.wrYPRR",
      "team.wr1DRR",
      "team.yardsPerTarget",
      "team.yacPerReception",
      "team.contestedCatchRate",
      "team.routeWinRateRanks",
      "team.offseasonWRUpgrades"
    ],
    defaults: {
      season: 2024,
      cpoe: 0,
      adjustedCompletionPct: 65,
      deepAccuracyRate: 50,
      pressureToSackRate: 20,
      passBlockGrade: 70,
      passBlockWinRate: 60,
      pressureRateAllowed: 35,
      pressureRateOverExpected: 0,
      wrYPRR: 1.5,
      wr1DRR: 0.08,
      yardsPerTarget: 7.5,
      yacPerReception: 5.5,
      contestedCatchRate: 50,
      routeWinRateRanks: [50],
      offseasonWRUpgrades: []
    },
    validation: [
      "If player.season < 2024, log 'Warning: Evaluation uses pre-2024 data' and reject unless explicitly requested.",
      "If team.routeWinRateRanks.length < 1, use default [50].",
      "If team.routeWinRateRanks contains values < 0 or > 100, clamp to 0-100."
    ]
  },
  // Type Definitions:
  // player: { season: number, position: string, scrambleRate: number, rushYPG: number, yardsPerCarry: number, explosiveRushRate: number, cpoe: number, adjustedCompletionPct: number, deepAccuracyRate: number, pressureToSackRate: number }
  // team: { passBlockGrade: number, passBlockWinRate: number, pressureRateAllowed: number, pressureRateOverExpected: number, wrYPRR: number, wr1DRR: number, yardsPerTarget: number, yacPerReception: number, contestedCatchRate: number, routeWinRateRanks: number[], offseasonWRUpgrades: string[] }
  // contextMetrics: { logs: string[], contextScore: number, lastEvaluatedSeason: number }
  logic: ({ player, team }) => {
    if (player.position !== "QB") return { logs: ["Not a QB. Skipped."], contextScore: 0, lastEvaluatedSeason: 2024 };

    let contextScore = 0;
    const logs = [];

    // Rushing Upside
    if (player.scrambleRate > 0.08) { contextScore += 0.4; logs.push("Elite scramble rate"); }
    if (player.rushYPG > 25) { contextScore += 0.3; logs.push("Strong rushing YPG"); }
    if (player.yardsPerCarry > 5.0) { contextScore += 0.3; logs.push("Elite YPC"); }
    if (player.explosiveRushRate > 0.15) { contextScore += 0.2; logs.push("Explosive rushing boost"); }

    // Accuracy & Pressure
    if (player.cpoe > 0) { contextScore += 0.2; logs.push("Positive CPOE"); }
    if (player.adjustedCompletionPct > 68) { contextScore += 0.2; logs.push("Strong Adj. Comp%"); }
    if (player.deepAccuracyRate > 55) { contextScore += 0.2; logs.push("Accurate deep thrower"); }
    if (player.pressureToSackRate < 18) { contextScore += 0.2; logs.push("Good pocket awareness"); }

    // Offensive Line Quality
    if (team.passBlockGrade > 75) { contextScore += 0.25; logs.push("Strong PFF pass block grade"); }
    if (team.passBlockWinRate > 62) { contextScore += 0.2; logs.push("Above avg. PB win rate"); }
    if (team.pressureRateAllowed < 32) { contextScore += 0.15; logs.push("Low pressure allowed"); }
    if (team.pressureRateOverExpected < 0) { contextScore += 0.1; logs.push("Better than expected protection"); }

    // WR Context (Negative Weights)
    if (team.wrYPRR < 1.3) { contextScore -= 0.2; logs.push("Low WR YPRR"); }
    if (team.wr1DRR < 0.07) { contextScore -= 0.2; logs.push("Weak 1st Down Conversion rate"); }
    if (team.yardsPerTarget < 7) { contextScore -= 0.1; logs.push("Low Yards/Target"); }
    if (team.yacPerReception < 5.2) { contextScore -= 0.1; logs.push("Weak YAC"); }
    if (team.contestedCatchRate < 45) { contextScore -= 0.1; logs.push("Poor contested catch rate"); }

    // Route Win Rate Check
    const validRanks = team.routeWinRateRanks.map(rank => Math.max(0, Math.min(100, rank)));
    const weakWinRanks = validRanks.filter(rank => rank > 50);
    if (weakWinRanks.length >= 3) { contextScore -= 0.2; logs.push("WRs below average in separation"); }

    // Offseason Upgrades
    if (team.offseasonWRUpgrades?.length > 0) {
      contextScore += 0.3;
      logs.push("Offseason WR additions counted");
    }

    return {
      logs: logs.length ? logs : ["No QB context adjustments applied"],
      contextScore: Number(contextScore.toFixed(2)),
      lastEvaluatedSeason: 2024
    };
  },
  examplePlayer: {
    name: "Example QB",
    season: 2024,
    context: {
      season: 2024,
      position: "QB",
      scrambleRate: 0.09,
      rushYPG: 30,
      yardsPerCarry: 5.5,
      explosiveRushRate: 0.18,
      cpoe: 0.02,
      adjustedCompletionPct: 70,
      deepAccuracyRate: 57,
      pressureToSackRate: 15,
      team: {
        passBlockGrade: 78,
        passBlockWinRate: 65,
        pressureRateAllowed: 30,
        pressureRateOverExpected: -0.02,
        wrYPRR: 1.4,
        wr1DRR: 0.08,
        yardsPerTarget: 7.8,
        yacPerReception: 5.7,
        contestedCatchRate: 48,
        routeWinRateRanks: [40, 55, 60],
        offseasonWRUpgrades: ["WR1 Upgrade"]
      }
    },
    outcome: {
      lastEvaluatedSeason: 2024,
      contextScore: 2.45,
      logs: [
        "Elite scramble rate",
        "Strong rushing YPG",
        "Elite YPC",
        "Explosive rushing boost",
        "Positive CPOE",
        "Strong Adj. Comp%",
        "Accurate deep thrower",
        "Good pocket awareness",
        "Strong PFF pass block grade",
        "Above avg. PB win rate",
        "Low pressure allowed",
        "Better than expected protection",
        "Offseason WR additions counted"
      ]
    }
  }
});