interface PlayerInput {
  season: number;
  position: string;
  tpRR: number; // Targets per route run
  ypRR: number; // Yards per route run
  oneDRR: number; // First downs per route run
  firstReadTargetPct: number;
  fantasyPointsPerGame: number;
  dropRate: number; // 0–1
  routeWinRate: number; // 0–1
  age: number;
  draftCapital: 'R1' | 'R2' | 'R3' | 'R4+' | 'UDFA';
  explosivePlayRate: number;
  slotRate: number; // 0–1
  routeParticipation: number; // 0–1
  teamPassAttemptsPerGame: number;
  wrRoomTargetCompetition: number; // 0–3
  qbStabilityScore: number; // 0–1
  contractYearsRemaining: number;
  previousSeasons?: { season: number; ypRR: number; tpRR: number; targetShare: number; firstReadTargetPct: number; fantasyPointsPerGame: number }[];
}

interface EvaluationOutput {
  contextScore: number; // 0–100
  logs: string[];
  tags: string[];
  subScores: {
    usageProfile: number;
    efficiency: number;
    roleSecurity: number;
    growthTrajectory: number;
  };
  lastEvaluatedSeason: number;
}

class WREvaluationService {
  private version = '1.2';
  private readonly weights = {
    usageProfile: 0.3,
    efficiency: 0.3,
    roleSecurity: 0.2,
    growthTrajectory: 0.2,
  };

  private evaluateUsageProfile(player: PlayerInput): { score: number; logs: string[]; tags: string[] } {
    let score = 0;
    const logs: string[] = [];
    const tags: string[] = [];

    if (player.tpRR > 0.22) { score += 25; logs.push('High TPRR'); tags.push('Alpha Usage'); }
    if (player.firstReadTargetPct > 0.25) { score += 20; logs.push('Strong First Read %'); }
    if (player.routeParticipation > 0.9) { score += 20; logs.push('Elite Route Participation'); }
    if (player.teamPassAttemptsPerGame > 30) { score += 15; logs.push('High Pass Volume'); }
    if (player.tpRR < 0.15) { score -= 20; logs.push('Low TPRR'); tags.push('Spike Risk'); }

    return { score: Math.max(0, Math.min(score, 100)), logs, tags };
  }

  private evaluateEfficiency(player: PlayerInput): { score: number; logs: string[]; tags: string[] } {
    let score = 0;
    const logs: string[] = [];
    const tags: string[] = [];

    if (player.ypRR > 2.0) { score += 25; logs.push('Elite YPRR'); tags.push('Efficient Weapon'); }
    else if (player.ypRR > 1.7) { score += 15; logs.push('Strong YPRR'); }
    else if (player.ypRR < 1.3) { score -= 15; logs.push('Inefficient YPRR'); }

    if (player.oneDRR > 0.08) { score += 15; logs.push('High First Down Rate'); }
    if (player.dropRate < 0.05) { score += 10; logs.push('Reliable Hands'); }
    else if (player.dropRate > 0.08) { score -= 10; logs.push('Drop Concerns'); }

    if (player.routeWinRate > 0.5) { score += 10; logs.push('Good Route Win Rate'); }
    else if (player.routeWinRate < 0.35) { score -= 10; logs.push('Poor Route Win Rate'); }

    if (player.explosivePlayRate > 0.15) { score += 10; logs.push('Explosive Playmaker'); tags.push('Big Play Threat'); }
    else if (player.explosivePlayRate < 0.1) { score -= 10; logs.push('Low Explosive Plays'); }

    return { score: Math.max(0, Math.min(score, 100)), logs, tags };
  }

  private evaluateRoleSecurity(player: PlayerInput): { score: number; logs: string[]; tags: string[] } {
    let score = 0;
    const logs: string[] = [];
    const tags: string[] = [];

    if (player.routeParticipation > 0.85) { score += 20; logs.push('Consistent Route Role'); tags.push('Role Secure'); }
    if (player.slotRate > 0.5) { score += 10; logs.push('Slot Flexibility'); }

    if (player.wrRoomTargetCompetition < 1.5) {
      score += 15;
      logs.push('Low WR Competition');
      tags.push('Path to Volume');
    } else if (player.wrRoomTargetCompetition > 2.0) {
      score -= 10;
      logs.push('Crowded WR Room');
    }

    if (player.qbStabilityScore > 0.7) { score += 10; logs.push('Stable QB Environment'); }
    else if (player.qbStabilityScore < 0.4) { score -= 10; logs.push('Unstable QB Environment'); }

    if (player.contractYearsRemaining >= 2) { score += 10; logs.push('Long-Term Contract'); }

    return { score: Math.max(0, Math.min(score, 100)), logs, tags };
  }

  private evaluateGrowthTrajectory(player: PlayerInput): { score: number; logs: string[]; tags: string[] } {
    let score = 0;
    const logs: string[] = [];
    const tags: string[] = [];

    if (player.age < 25) { score += 20; logs.push('Young with Upside'); tags.push('Breakout Candidate'); }
    else if (player