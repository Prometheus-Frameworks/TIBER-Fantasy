ğŸ“¦ OTC Power â€” Shipment Manifest for Tiber
âœ… Core Service

Schema files

sql/001_schema.sql â†’ base tables (players, player_week_facts, power_ranks, events_queue, bt_week_points, bt_market_rank)

sql/002_indexes.sql â†’ indexes for fast lookups

Infrastructure

src/infra/db.ts â†’ Postgres pool + query helper

src/infra/logger.ts â†’ structured logger

Server

src/server.ts â†’ Fastify app, registers routes, init DB

src/api/powerRoutes.ts â†’ REST endpoints:

GET /api/power/OVERALL|QB|RB|WR|TE

GET /api/power/player/:id

POST /api/power/events

âœ… Jobs / Pipelines

src/jobs/nightlyRecalc.ts â†’ full recompute loop

src/jobs/eventRecalc.ts â†’ event worker, bypasses smoothing on real events

src/jobs/validation.ts â†’ backtest harness (Spearman, hit %, drift payoff)

Importers:

src/jobs/importSleeperPoints.ts â†’ Sleeper stats â†’ bt_week_points

src/jobs/importEcrCsv.ts â†’ CSV fallback for ECR

src/jobs/scrapeFantasyProsEcr.ts â†’ FantasyPros live scraper, 2s delay, unmatched tracker

âœ… Utilities

src/util/normalizeName.ts â†’ normalize player names

Alias Resolver (added in scraper)

players_aliases table creation

Scraper checks alias map before name index

âœ… Scoring / Config

src/core/scoring.ts â†’ computePowerScore (with SOS multiplier hook)

src/core/smoothing.ts â†’ clampDelta hysteresis

src/core/types.ts â†’ PlayerFacts, etc.

src/core/config.ts (or weights.ts) â†’ position weights

Latest Tunings:

QB env â†’ 0.30

RB availability â†’ 0.13 (usage â†’ 0.37)

WR/TE unchanged

Market anchor hard-capped at 0.05

âœ… Phase 3 Hooks

Confidence gating function stub in nightlyRecalc.ts

Rookies/new roles start at ~0.65 conf until 3 games

Opponent/SOS multiplier stub wired in scoring.ts

Cron scaffolding doc in /docs/DEPLOY.md

âœ… Package.json Scripts

npm run dev â†’ start Fastify server

npm run recalc:nightly â†’ nightly recompute

npm run recalc:events â†’ event worker

npm run validate â†’ backtest validation

npm run bt:import:sleeper â†’ backfill Sleeper points

npm run bt:import:ecr â†’ load CSV ECR

npm run bt:scrape:ecr â†’ scrape FantasyPros ECR

ğŸ›¡ï¸ Tiberâ€™s Checklist

Pull repo and npm i (ensure cheerio is installed for scraper).

Confirm DB schema applied (001_schema.sql + 002_indexes.sql).

Run Sleeper backfill â†’ expect ~9k rows in bt_week_points.

Run ECR scraper for one slice â†’ expect bt_market_rank fills + any stragglers in bt_market_rank_unmatched.

Run nightly recalc â†’ check power_ranks has ~500 players per slice.

Smoke test API:

curl "http://localhost:8084/api/power/OVERALL?season=2025&week=1"


Should return items with power_score + delta_w.

Run event worker â†’ post a QB_CHANGE event, see WR/TE ranks shift unclamped.

Run validation â†’ confirm rho/hit logs appear for all slices.

Check config.ts weights reflect RB avail=0.13 / usage=0.37 and QB env=0.30.

Docs: Verify /docs/DEPLOY.md exists with cron examples.

ğŸ‘‰ If Tiber checks off all 10, heâ€™s fully synced with what weâ€™ve delivered.