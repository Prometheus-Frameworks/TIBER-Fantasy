üì¶ Tiber Handoff ‚Äî /api/sos/weekly ‚Üí samples=N (Top players vs DEF + total)
What this adds

When the client calls:

/api/sos/weekly?season=2024&week=6&position=RB&mode=ctx&samples=3&debug=1


each row gains:

{
  "team": "TB",
  "opponent": "NO",
  "score": 63,
  "tier": "yellow",
  "samples": {
    "total": 54.2,
    "players": [
      {"name":"Sean Tucker","team":"TB","fpts":35.2},
      {"name":"Bucky Irving","team":"TB","fpts":19.0},
      {"name":"RB3 Name","team":"TB","fpts":0.0}
    ]
  }
}

1) Controller: parse & clamp samples

File: server/src/modules/sos/sos.controller.ts

const season   = parseInt((req.query.season as string)  ?? '2024', 10);
const week     = parseInt((req.query.week as string)    ?? '1',    10);
const position = (req.query.position as 'RB'|'WR'|'QB'|'TE') ?? 'RB';
const mode     = (req.query.mode as 'fpa'|'ctx') ?? 'fpa';
const debug    = req.query.debug === '1';

const samplesRaw = parseInt((req.query.samples as string) ?? '0', 10);
const samples = Number.isFinite(samplesRaw) ? Math.max(0, Math.min(samplesRaw, 5)) : 0; // clamp 0..5

const data = await sosService.getWeeklySOS({ season, week, position, mode, debug, samples });
return res.json({ season, week, position, mode, items: data });

2) Service: no N+1 ‚Äî pull all top-N + totals in two queries and merge

File: server/src/modules/sos/sos.service.ts

type WeeklyParams = {
  season: number; week: number; position: 'RB'|'WR'|'QB'|'TE';
  mode: 'fpa'|'ctx'; debug: boolean; samples: number;
};

export async function getWeeklySOS(params: WeeklyParams) {
  const { season, week, position, mode, debug, samples } = params;

  // 1) Existing flow: build base rows with team, opponent, score, tier (unchanged)
  const baseRows = await buildWeeklyRows({ season, week, position, mode, debug }); 
  // baseRows: Array<{ team:string; opponent:string; score:number; tier:'green'|'yellow'|'red'; /* +debug bits */ }>

  if (!samples) return baseRows;

  // 2) Fetch all top-N players per DEF (window function), once
  //    and the totals per DEF, once. Then map by def_team.
  const topPlayers = await db.$queryRaw<Array<{def_team:string; player_name:string; player_team:string; fpts:number}>>`
    SELECT def_team, player_name, player_team, fpts
    FROM (
      SELECT def_team, player_name, player_team, fpts,
             ROW_NUMBER() OVER (PARTITION BY def_team ORDER BY fpts DESC) AS rn
      FROM player_vs_defense
      WHERE season = ${season} AND week = ${week} AND position = ${position}
    ) t
    WHERE rn <= ${samples};
  `;

  const totals = await db.$queryRaw<Array<{def_team:string; total_fpts:string}>>`
    SELECT def_team, SUM(fpts)::text AS total_fpts
    FROM player_vs_defense
    WHERE season = ${season} AND week = ${week} AND position = ${position}
    GROUP BY def_team;
  `;

  // 3) Index for quick attach
  const playersByDef = new Map<string, Array<{name:string; team:string; fpts:number}>>();
  for (const r of topPlayers) {
    const arr = playersByDef.get(r.def_team) ?? [];
    arr.push({ name: r.player_name, team: r.player_team, fpts: Number(r.fpts) });
    playersByDef.set(r.def_team, arr);
  }
  const totalsByDef = new Map<string, number>();
  for (const t of totals) totalsByDef.set(t.def_team, Number(t.total_fpts));

  // 4) Attach to rows (opponent = defense)
  return baseRows.map((row) => {
    const players = playersByDef.get(row.opponent) ?? [];
    const total   = totalsByDef.get(row.opponent);
    if (players.length === 0 && total == null) return row; // no samples for this DEF
    return {
      ...row,
      samples: {
        total: Number.isFinite(total as number) ? (total as number) : 0,
        players
      }
    };
  });
}


Notes
‚Ä¢ Uses Postgres window function to avoid per-row queries.
‚Ä¢ Relies on player_vs_defense indexes already defined.
‚Ä¢ Keeps existing SOS scoring code untouched.

3) Types (if you keep TS types strict)

File: server/src/modules/sos/types.ts

export type SamplePlayer = { name: string; team: string; fpts: number };
export type RowSamples   = { total: number; players: SamplePlayer[] };

export type WeeklyRow = {
  team: string; opponent: string; score: number; tier: 'green'|'yellow'|'red';
  debug?: { /* existing breakdown */ };
  samples?: RowSamples;
};

4) UI: show it (already scaffolded)

You already have the ‚ÄúSamples‚Äù expand plan in SOS. With this API live:

Call /api/sos/weekly?...&samples=3 (or fetch on row expand).

Render row.samples.total and row.samples.players (with TeamLogo).

Minimal row-expander UI reminder:

{row.samples && (
  <div className="mt-2 bg-gray-50 border rounded p-3">
    <div className="flex items-center gap-3 mb-2">
      <span className="text-sm font-semibold">
        Total {position} FPTS vs {row.opponent}:
      </span>
      <span className="font-bold">{row.samples.total.toFixed(1)}</span>
    </div>
    <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
      {row.samples.players.map((p) => (
        <div key={p.name} className="flex items-center gap-2 border rounded px-3 py-2">
          <TeamLogo team={p.team} size={18} />
          <div className="text-sm">
            <div className="font-medium">{p.name}</div>
            <div className="text-xs text-gray-600">{p.team}</div>
          </div>
          <div className="ml-auto font-semibold">{p.fpts.toFixed(1)}</div>
        </div>
      ))}
    </div>
  </div>
)}

5) QA hits (copy/paste)
# Expect samples attached, with totals and top players
curl "/api/sos/weekly?season=2024&week=6&position=RB&mode=ctx&samples=3&debug=1" | jq '.items[] | select(.opponent=="NO") | .samples'

# Cross-check totals match Leaders endpoint
curl "/api/leaders/allowed?season=2024&week=6&position=RB" | jq '.items[] | select(.def_team=="NO")'

6) Definition of Done

 /api/sos/weekly accepts samples (0..5) and returns samples.total + samples.players per row.

 Query is batched (window function), not per-row N+1.

 UI shows the panel (either included in main fetch or on expand fetch).

 Random spot-check (e.g., 2024 Wk 6 RBs vs NO) matches Leaders totals.