export function generateTierBubbles(
  playerRankings: PlayerRankingForBubbles[],
  rankDiffThreshold: number = 1.5,
  stdDevThreshold: number = 5.0,
  groupStdThreshold: number = 4.0
): { players: PlayerRankingForBubbles[], consensus_strength: 'tight' | 'moderate' | 'loose' }[] {
  if (playerRankings.length === 0) return [];

  const sortedPlayers = [...playerRankings].sort((a, b) => a.average_rank - b.average_rank);
  
  // Precompute median rank diff for relative gap detection
  const diffs = [];
  for (let i = 1; i < sortedPlayers.length; i++) {
    diffs.push(sortedPlayers[i].average_rank - sortedPlayers[i-1].average_rank);
  }
  const medianDiff = diffs.sort((a, b) => a - b)[Math.floor(diffs.length / 2)] || 1.0;
  const gapThreshold = Math.max(rankDiffThreshold, 2 * medianDiff);

  const bubbles: { players: PlayerRankingForBubbles[], consensus_strength: 'tight' | 'moderate' | 'loose' }[] = [];
  let currentBubble: PlayerRankingForBubbles[] = [sortedPlayers[0]];

  for (let i = 1; i < sortedPlayers.length; i++) {
    const player = sortedPlayers[i];
    const prevPlayer = sortedPlayers[i-1];
    const avgDiff = player.average_rank - prevPlayer.average_rank;
    
    // Compute tentative group std if adding
    const tentativeGroup = [...currentBubble, player];
    const groupStds = tentativeGroup.map(p => p.standard_deviation);
    const avgGroupStd = groupStds.reduce((sum, std) => sum + std, 0) / groupStds.length;

    if (avgDiff <= gapThreshold && player.standard_deviation <= stdDevThreshold && avgGroupStd <= groupStdThreshold) {
      currentBubble.push(player);
    } else {
      bubbles.push(createSimplifiedTier(currentBubble));
      currentBubble = [player];
    }
  }

  if (currentBubble.length > 0) {
    bubbles.push(createSimplifiedTier(currentBubble));
  }

  return bubbles;
}

function createSimplifiedTier(players: PlayerRankingForBubbles[]): { players: PlayerRankingForBubbles[], consensus_strength: 'tight' | 'moderate' | 'loose' } {
  const stds = players.map(p => p.standard_deviation);
  const avgStd = stds.reduce((sum, std) => sum + std, 0) / stds.length;
  
  let consensus_strength: 'tight' | 'moderate' | 'loose';
  if (avgStd <= 2.0) consensus_strength = 'tight';
  else if (avgStd <= 4.0) consensus_strength = 'moderate';
  else consensus_strength = 'loose';

  return { players, consensus_strength };
}