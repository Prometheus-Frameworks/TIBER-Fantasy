ðŸ§ª FORGE Hotfix â€“ Use 2025 Data for Environment & Matchup

Goal

Update all FORGE environment + matchup logic (including debug endpoints) to use 2025 data by default instead of 2024, while keeping season configurable via query params. Rankings UIs should now be reading 2025 envScore/matchupScore.

1. Files to Inspect

Search for these patterns:

season = 2024

WHERE season = 2024

"season": 2024

Any env/matchup services that donâ€™t take a season argument

Likely files:

server/routes/forgeEnvDebug.ts or similar (env debug endpoint)

server/routes/forgeMatchupDebug.ts or similar (matchup debug endpoint)

server/services/environmentService.ts

server/services/matchupService.ts

Any SQL / migrations that define team_environment and team_matchup_context materialized views

2. Season Handling â€“ Core Rules

Implement these rules everywhere FORGE env/matchup are used:

Default season is 2025

Season must be overridable from:

Query param ?season=YYYY on debug routes

Function arguments on service functions

No more hard-coded 2024 in env/matchup code paths

3. Concrete Changes
3.1 Debug Endpoints

Current (example):

// /api/forge/env-debug
router.get('/api/forge/env-debug', async (req, res) => {
  const { team } = req.query;

  const season = 2024;
  const week = 4; // or whatever

  const debug = await forgeEnvService.getDebugEnv({
    team: String(team),
    season,
    week,
  });

  res.json(debug);
});


Update to:

router.get('/api/forge/env-debug', async (req, res) => {
  const { team, season: seasonParam, week: weekParam } = req.query;

  const season = seasonParam ? Number(seasonParam) : 2025;
  const week   = weekParam ? Number(weekParam)   : 4; // keep default week if you want

  const debug = await forgeEnvService.getDebugEnv({
    team: String(team),
    season,
    week,
  });

  res.json(debug);
});


Same pattern for:

GET /api/forge/matchup-debug?defense=NYJ&position=WR


Make it:

router.get('/api/forge/matchup-debug', async (req, res) => {
  const { defense, position, season: seasonParam, week: weekParam } = req.query;

  const season = seasonParam ? Number(seasonParam) : 2025;
  const week   = weekParam ? Number(weekParam)   : 4;

  const debug = await forgeMatchupService.getDebugMatchup({
    defense: String(defense),
    position: String(position) as Position,
    season,
    week,
  });

  res.json(debug);
});


Acceptance check:

Calling
GET /api/forge/matchup-debug?defense=NYJ&position=WR&season=2025&week=10
returns "season": 2025, "week": 10 in meta.

3.2 Services: getTeamEnvironment and getMatchupScore

Current (example):

export async function getTeamEnvironment(team: string, week: number): Promise<TeamEnvironment> {
  const res = await pool.query(
    `SELECT team, env_score_100 AS "envScore100"
     FROM team_environment
     WHERE team = $1 AND week = $2 AND season = 2024`,
    [team, week]
  );
  return res.rows[0];
}


Update to:

export async function getTeamEnvironment(
  team: string,
  week: number,
  season: number = 2025
): Promise<TeamEnvironment> {
  const res = await pool.query(
    `SELECT season, week, team, env_score_100 AS "envScore100"
     FROM team_environment
     WHERE team = $1 AND week = $2 AND season = $3`,
    [team, week, season]
  );
  return res.rows[0];
}


Same for matchup:

export async function getMatchupScore(
  offenseTeam: string,
  defenseTeam: string,
  position: Position,
  week: number,
  season: number = 2025
): Promise<MatchupContext> {
  const res = await pool.query(
    `SELECT season,
            week,
            defense_team AS "defenseTeam",
            position,
            matchup_score_100 AS "matchupScore100"
     FROM team_matchup_context
     WHERE defense_team = $1
       AND position = $2
       AND week = $3
       AND season = $4`,
    [defenseTeam, position, week, season]
  );

  return {
    season,
    week,
    offenseTeam,
    defenseTeam,
    position,
    matchupScore100: res.rows[0]?.matchupScore100 ?? 50,
  };
}


Acceptance check:

Any code calling these services without specifying season now uses 2025.

Calls from rankings code (WR/RB pages) should pass the current week and rely on default season 2025.

3.3 Materialized Views / SQL

If the views are already built off a unified PBP / weekly table with a season column, we probably only need the season filter at query time.

But if any view itself has WHERE season = 2024, update it:

CREATE MATERIALIZED VIEW team_environment AS
SELECT
  season,
  week,
  posteam AS team,
  env_score_100
FROM some_aggregated_table
-- REMOVE any hardcoded "WHERE season = 2024"
;


Then rely on the service layer to filter by season.

If there is a hard-coded filter, change it to include 2025 or drop the filter entirely:

WHERE season IN (2024, 2025)


Then:

-- in migration / startup
REFRESH MATERIALIZED VIEW CONCURRENTLY team_environment;
REFRESH MATERIALIZED VIEW CONCURRENTLY team_matchup_context;

4. Rankings Integration Check

Once the above is done, confirm:

/rankings/wr and /rankings/rb â†’ when you change week to something like 10 or 11, the underlying FORGE calls are using:

season = 2025

week = selectedWeek

The ForgeTransparencyPanel or any env/matchup tooltips should now show season: 2025 when they pull debug data.

If the frontend is hardcoding season=2024 in any fetch call to debug endpoints, update to:

const currentSeason = 2025;

fetch(`/api/forge/matchup-debug?defense=${def}&position=${pos}&season=${currentSeason}&week=${week}`);

5. Do NOT Touch

Color scheme, layout, styling â€“ no CSS or theme changes

Any existing FORGE alpha math logic beyond wiring the correct season into env/matchup