ðŸ§ª Ratings v1 â€” QA Script Bundle (copy-paste)

Assumes: API running on http://localhost:3000 (adjust HOST if needed), Postgres via psql, season 2024, weeks 1â€“17 loaded.

0) Shell setup
export HOST="http://localhost:3000"
export SEASON=2024
export WEEK=6

1) Data ingestion sanity
Profiles present (rough order of magnitude)
-- Expect hundreds of rows, QB/RB/WR/TE only
SELECT position, COUNT(*) 
FROM player_profile 
GROUP BY 1 ORDER BY 1;

Inputs present for W1â€“17
-- Expect 1kâ€“2k+ rows total depending on coverage
SELECT MIN(week) AS min_wk, MAX(week) AS max_wk, COUNT(*) AS rows
FROM player_inputs
WHERE season = :SEASON;

Key fields not empty
SELECT COUNT(*) AS missing_snap_pct
FROM player_inputs
WHERE season = :SEASON AND (snap_pct IS NULL OR snap_pct = 0);

SELECT COUNT(*) AS have_sos_ctx
FROM player_inputs
WHERE season = :SEASON AND sos_ctx IS NOT NULL;

2) API smoke (200s, non-empty)
curl -sf "$HOST/api/ratings?format=redraft&position=RB&season=$SEASON&week=$WEEK&limit=25" | jq '.items[0]'
curl -sf "$HOST/api/ratings?format=dynasty&position=WR&season=$SEASON&limit=25" | jq '.items[0]'
curl -sf "$HOST/api/players/$(echo 12345)/rating?format=redraft&season=$SEASON&week=$WEEK" | jq '.player_id' || true
curl -sf "$HOST/api/ratings/tiers?format=redraft&position=QB&season=$SEASON&week=$WEEK" | jq

Error handling
# Invalid format
curl -s -o /dev/null -w "%{http_code}\n" "$HOST/api/ratings?format=INVALID&position=RB&season=$SEASON"

# Invalid position
curl -s -o /dev/null -w "%{http_code}\n" "$HOST/api/ratings?format=redraft&position=DL&season=$SEASON"

# Week out of bounds (2024 has 17)
curl -s -o /dev/null -w "%{http_code}\n" "$HOST/api/ratings?format=redraft&position=RB&season=$SEASON&week=18"

3) Debug math checks (components â‰ˆ score)
# Fetch a small set with debug
curl -sf "$HOST/api/ratings?format=redraft&position=RB&season=$SEASON&week=$WEEK&debug=1&limit=10" \
| jq -r '
  .items[] |
  {name: .player_name, score: .score, d: .debug} |
  "\(.name)\t\(.score)\t\(.d.opp)\t\(.d.eff)\t\(.d.role)\t\(.d.team)\t\(.d.health)\t\(.d.sos)"
' > /tmp/rdbg.tsv

echo -e "Player\tScore\tOpp\tEff\tRole\tTeam\tHealth\tSOS"; head -n 5 /tmp/rdbg.tsv


Spot check:
Score â‰ˆ 0.35*Opp + 0.25*Eff + 0.15*Role + 0.10*Team + 0.10*(Health) + 0.05*(SOS).
(Health and SOS may already be scaled; tolerate Â±1.0 rounding diff.)

4) Percentile normalization sanity (0â€“100 spread)
SELECT position,
       ROUND(MIN(score)::numeric,1) AS min_s,
       ROUND(MAX(score)::numeric,1) AS max_s,
       ROUND(AVG(score)::numeric,1) AS avg_s,
       COUNT(*) AS n
FROM player_scores
WHERE season = :SEASON AND format = 'redraft'
GROUP BY 1 ORDER BY 1;


Expect: min ~10â€“20, max ~90+, avg ~50.

5) VOR validity (replacement slot math)
-- Replacement ranks: RB40, WR48, TE16, QB12
WITH repl AS (
  SELECT 'RB'::text AS position, 40 AS rk UNION ALL
  SELECT 'WR', 48 UNION ALL
  SELECT 'TE', 16 UNION ALL
  SELECT 'QB', 12
),
base AS (
  SELECT ps.*, ROW_NUMBER() OVER (PARTITION BY ps.position ORDER BY ps.score DESC) AS rnk
  FROM player_scores ps
  WHERE season = :SEASON AND format = 'redraft'
),
repl_scores AS (
  SELECT b.position, b.score AS repl_score
  FROM base b
  JOIN repl r ON r.position=b.position
  WHERE b.rnk = r.rk
)
SELECT b.player_name, b.position, ROUND(b.score::numeric,2) AS score,
       ROUND(b.vor::numeric,2) AS vor,
       ROUND((b.score - rs.repl_score)::numeric,2) AS calc_vor,
       ROUND(ABS((b.vor - (b.score - rs.repl_score)))::numeric,3) AS diff
FROM base b
JOIN repl_scores rs USING (position)
WHERE b.rnk <= 10
ORDER BY b.position, b.rnk;


Expect: diff ~ 0.000â€“0.050.

6) Tier clustering sanity
SELECT position, format, tier, COUNT(*) AS n,
       ROUND(MIN(score)::numeric,1) AS min_s,
       ROUND(MAX(score)::numeric,1) AS max_s
FROM player_scores
WHERE season = :SEASON
GROUP BY 1,2,3
ORDER BY position, format, tier;


Expect: no single-player tiers (n â‰¥ 3) and sensible score ranges per tier.

7) Weight override acceptance
# Valid override (RB redraft)
curl -sf "$HOST/api/ratings?format=redraft&position=RB&season=$SEASON&week=$WEEK&weights=opp:0.40,eff:0.30,role:0.15,team:0.10,health:0.03,sos:0.02&debug=1" \
| jq '.items[0].debug'

# Invalid keys rejected
curl -s -o /dev/null -w "%{http_code}\n" "$HOST/api/ratings?format=redraft&position=RB&season=$SEASON&week=$WEEK&weights=foo:1.0"

# Not summing to ~1.0 â†’ 400 or normalized (whatever spec says)
curl -s -o /dev/null -w "%{http_code}\n" "$HOST/api/ratings?format=redraft&position=RB&season=$SEASON&week=$WEEK&weights=opp:1,eff:1"

8) Dynasty specifics
Age curve present (spot check)
SELECT ps.player_name, pp.age, 
       (ps.debug_json->>'Age')::numeric AS age_comp
FROM player_scores ps
JOIN player_profile pp USING (player_id)
WHERE ps.season = :SEASON AND ps.format='dynasty' AND ps.position='RB'
ORDER BY age_comp DESC NULLS LAST
LIMIT 10;


Expect: younger RBs trending higher age component, older trending lower.

3-Year projection component present
curl -sf "$HOST/api/ratings?format=dynasty&position=WR&season=$SEASON&debug=1&limit=10" \
| jq '.items[] | {player: .player_name, proj3: .debug.proj3}'

9) SOS integration sanity (small influence, non-dominant)
curl -sf "$HOST/api/ratings?format=redraft&position=WR&season=$SEASON&week=$WEEK&debug=1&limit=10" \
| jq '.items[] | {player: .player_name, sos: .debug.sos}'


Expect values that move the needle slightly, not overhaul rankings.

10) Single-player endpoint & trend
# Pick a player_id from a list call
PID=$(curl -s "$HOST/api/ratings?format=redraft&position=WR&season=$SEASON&week=$WEEK&limit=1" | jq -r '.items[0].player_id')

curl -sf "$HOST/api/players/$PID/rating?format=redraft&season=$SEASON&week=$WEEK" | jq


Expect current + a short trend array of week/score pairs.

11) Recompute job (admin)
# If protected, add token header; else just call
curl -s -X POST "$HOST/api/ratings/recompute" -H "Authorization: Bearer $ADMIN_TOKEN" | jq


Expect success JSON + no changes to stable weeks unless inputs changed.

12) Performance quick checks
time curl -sf "$HOST/api/ratings?format=redraft&position=ALL&season=$SEASON&week=$WEEK&limit=500" >/dev/null
time curl -sf "$HOST/api/players/$PID/rating?format=redraft&season=$SEASON&week=$WEEK" >/dev/null
time curl -sf "$HOST/api/ratings/tiers?format=redraft&position=RB&season=$SEASON&week=$WEEK" >/dev/null


Targets:

/api/ratings?limit=100 < 500ms

/api/players/:id/rating < 200ms

/api/ratings/tiers < 300ms

13) URL state compatibility (manual UI)

Change format redraft â‡„ dynasty â†’ table updates.

Flip week â†’ trend reflects the new week.

Apply weights override in URL â†’ visible score/ordering shifts.

debug=1 shows component rows under each player.

14) Final pass / sign-off
-- No scores outside 0â€“100
SELECT COUNT(*) AS out_of_bounds
FROM player_scores
WHERE score < 0 OR score > 100;

-- Reasonable medians per position/format
SELECT position, format, 
       PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY score) AS median_score
FROM player_scores
WHERE season = :SEASON
GROUP BY 1,2
ORDER BY 1,2;


Expect out_of_bounds = 0, medians around ~50.