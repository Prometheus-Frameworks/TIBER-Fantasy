import {
  QBEnvironmentContextScoreService,
  RBEvaluationService,
  WREvaluationService,
  TEEvaluationService,
} from './evaluationModules';

// Position-specific input interfaces
interface QBPlayerInput {
  season: number;
  position: string;
  playerName: string;
  scrambleRate: number; // 0–1
  rushYPG: number;
  yardsPerCarry: number;
  explosiveRushRate: number; // 0–1
  cpoe: number;
  adjustedCompletionPct: number; // 0–1
  deepAccuracyRate: number; // 0–1
  pressureToSackRate: number; // 0–1
  team: {
    passBlockGrade: number;
    passBlockWinRate: number; // 0–1
    pressureRateAllowed: number; // 0–1
    pressureRateOverExpected: number;
    wrYPRR: number;
    wr1DRR: number;
    yardsPerTarget: number;
    yacPerReception: number;
    contestedCatchRate: number; // 0–1
    routeWinRateRanks: number[]; // 0–100
    offseasonWRUpgrades: string[];
  };
}

interface RBPlayerInput {
  season: number;
  position: string;
  playerName: string;
  rushYardsPerGame: number;
  yardsPerCarry: number;
  receivingYards: number;
  targetShare: number;
  redZoneCarries: number;
  teamRunPlayRate: number;
  teamEPARank: number;
}

interface WRPlayerInput {
  season: number;
  position: string;
  playerName: string;
  tpRR: number;
  ypRR: number;
  oneDRR: number;
  firstReadTargetPct: number;
  fantasyPointsPerGame: number;
  dropRate: number;
  routeWinRate: number;
  age: number;
  draftCapital: 'R1' | 'R2' | 'R3' | 'R4+' | 'UDFA';
  explosivePlayRate: number;
  slotRate: number;
  routeParticipation: number;
  teamPassAttemptsPerGame: number;
  wrRoomTargetCompetition: number;
  qbStabilityScore: number;
  contractYearsRemaining: number;
  previousSeasons?: { season: number; ypRR: number; tpRR: number; targetShare: number; firstReadTargetPct: number; fantasyPointsPerGame: number }[];
}

interface TEPlayerInput {
  season: number;
  position: string;
  playerName: string;
  tpRR: number;
  ypRR: number;
  routeParticipation: number;
  redZoneTargetShare: number;
  expectedTDs: number;
  actualTDs: number;
  targetShare: number;
  catchRateOverExpected: number;
  redZoneTargetConsistency: number;
  age: number;
  contractYearsRemaining: number;
  teamEPARank: number;
  wrTargetCompetition: number;
  qbStabilityScore: number;
  teamPassVolume: number;
}

type PlayerInput = QBPlayerInput | RBPlayerInput | WRPlayerInput | TEPlayerInput;

interface EvaluationOutput {
  contextScore: number; // 0–100
  logs: string[];
  tags: string[];
  subScores: Record<string, number>;
  lastEvaluatedSeason: number;
  playerName: string;
}

interface BatchResult {
  QB: EvaluationOutput[];
  RB: EvaluationOutput[];
  WR: EvaluationOutput[];
  TE: EvaluationOutput[];
}

class BatchFantasyEvaluator {
  private version = '1.2';
  private readonly maxBatchSize = 100;
  private qbService = new QBEnvironmentContextScoreService();
  private rbService = new RBEvaluationService();
  private wrService = new WREvaluationService();
  private teService = new TEEvaluationService();

  private validateInput(player: PlayerInput): { isValid: boolean; logs: string[] } {
    const logs: string[] = [];
    if (!player.playerName) {
      logs.push('Missing playerName');
      return { isValid: false, logs };
    }
    if (player.season < 2024) {
      logs.push(`Warning: ${player.playerName} evaluation uses pre-2024 data (season: ${player.season})`);
      return { isValid: false, logs };
    }
    if (!['QB', 'RB',