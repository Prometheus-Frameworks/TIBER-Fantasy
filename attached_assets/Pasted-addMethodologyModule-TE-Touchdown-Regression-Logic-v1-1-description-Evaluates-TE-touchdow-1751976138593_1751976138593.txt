addMethodologyModule("TE Touchdown Regression Logic (v1.1)", {
  description: "Evaluates TE touchdown sustainability and regression risk based on TD rate, volume, red zone usage, pass volatility, and receiving floor.",
  triggerScope: ["dynastyValuation", "playerProfile", "analyticsPanel"],
  inputValidation: {
    requiredFields: [
      "player.tdRate", "player.seasonTDs", "player.careerTDRate", "player.routesRun", 
      "player.receptions", "player.targetShare", "player.receivingYards",
      "player.redZoneTargets", "player.inside10Targets", 
      "team.passAttempts", "team.redZonePassShare", "team.teTargetShare", "team.teTDShare",
      "team.passVolumeVolatility", "competition.teRoomDepth"
    ],
    defaults: {
      leagueAvgTETDRate: 0.055,
      redZoneThreshold: 8,
      volatilityThreshold: 0.12
    }
  },
  steps: [
    {
      step: "Flagging for Regression Risk",
      logic: [
        "Flag if player.tdRate > 2 * player.careerTDRate.",
        "Flag if player.seasonTDs >= 6 AND player.redZoneTargets < redZoneThreshold.",
        "Flag if player.inside10Targets < 4.",
        "Flag if player.targetShare < 0.12 AND team.teTDShare > 0.25.",
        "Flag if team.passVolumeVolatility > volatilityThreshold.",
        "Flag if competition.teRoomDepth >= 3."
      ]
    },
    {
      step: "Pass-Catching Floor Check",
      logic: [
        "If player.receptions < 40 AND player.routesRun < 300, log 'Low Receiving Floor'.",
        "If player.targetShare < 0.10 AND player.receivingYards < 400, apply -0.05 penalty to dynastyValueAdjustment."
      ]
    },
    {
      step: "Dynasty Value Adjustment",
      logic: [
        "If 2+ regression flags: apply -0.10.",
        "If 3+ regression flags: apply -0.20.",
        "If pass-catching penalty present: subtract additional -0.05.",
        "Cap dynastyValueAdjustment at -0.25.",
        "Add 'TE Regression Risk' tag if total penalty >= -0.10."
      ]
    }
  ],
  examplePlayer: {
    name: "Example TE",
    season: 2024,
    context: {
      tdRate: 0.18,
      seasonTDs: 8,
      careerTDRate: 0.06,
      routesRun: 270,
      receptions: 36,
      targetShare: 0.09,
      receivingYards: 390,
      redZoneTargets: 5,
      inside10Targets: 2,
      teamPassAttempts: 540,
      redZonePassShare: 0.18,
      teTDShare: 0.29,
      teTargetShare: 0.14,
      passVolumeVolatility: 0.15,
      competition: { teRoomDepth: 3 }
    },
    outcome: {
      flagged: true,
      dynastyValueAdjustment: -0.25,
      tags: ["TE Regression Risk"],
      logs: [
        "TD Rate > 2x Career Avg",
        "Low Red Zone Usage",
        "Low Inside-10 Usage",
        "Low Receiving Floor",
        "High TE TD Share",
        "Volatile Passing Offense",
        "Regression Penalty Applied: -0.25"
      ]
    }
  }
});