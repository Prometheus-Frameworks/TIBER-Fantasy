interface TradeEvaluationConfig {
  evenTradeThreshold: number;
  minContributionRatio: number; // Minimum % of total trade value per team
}

interface TradeVerdict {
  outcome: string;
  tag: string;
  recommendation: string;
  isLopsided?: boolean; // Optional flag for edge cases
}

const TRADE_CONFIG: TradeEvaluationConfig = {
  evenTradeThreshold: 50,
  minContributionRatio: 0.1, // 10% of total trade value
};

const calculateTradeBalanceIndex = (teamAScore: number, teamBScore: number): number => {
  const totalScore = teamAScore + teamBScore;
  if (totalScore <= 0) return 0;
  const maxScore = Math.max(teamAScore, teamBScore);
  const minScore = Math.min(teamAScore, teamBScore);
  return Math.round(((maxScore - minScore) / totalScore) * 100);
};

const checkLopsidedTrade = (
  teamAScore: number,
  teamBScore: number,
  config: TradeEvaluationConfig
): boolean => {
  const totalScore = teamAScore + teamBScore;
  if (totalScore <= 0) return false;
  const teamAContribution = teamAScore / totalScore;
  const teamBContribution = teamBScore / totalScore;
  return teamAContribution < config.minContributionRatio || teamBContribution < config.minContributionRatio;
};

const determineTradeVerdict = (
  teamAScore: number,
  teamBScore: number,
  config: TradeEvaluationConfig = TRADE_CONFIG
): TradeVerdict => {
  const tradeBalance = Math.abs(teamAScore - teamBScore);
  const balanceIndex = calculateTradeBalanceIndex(teamAScore, teamBScore);
  const isLopsided = checkLopsidedTrade(teamAScore, teamBScore, config);

  if (isLopsided) {
    return {
      outcome: 'Lopsided Trade',
      tag: '‚ö†Ô∏è Potential Throw-In',
      recommendation:
        'One team contributes less than 10% of total value. Consider balancing the trade or confirming intent.',
      isLopsided: true,
    };
  }

  if (balanceIndex < config.evenTradeThreshold) {
    return {
      outcome: 'Even',
      tag: '‚úÖ Fair Trade',
      recommendation: 'Trade is balanced. Slight edges may depend on team needs or league format.',
    };
  }

  const winningTeam = teamAScore > teamBScore ? 'Team A' : 'Team B';
  const losingTeam = teamAScore > teamBScore ? 'Team B' : 'Team A';
  return {
    outcome: `${winningTeam} wins`,
    tag: 'üî• Overpay Detected',
    recommendation: `${losingTeam} is giving up more value. Consider adding an elite asset or adjusting low-impact players.`,
  };
};

export { TradeVerdict, TradeEvaluationConfig, determineTradeVerdict, calculateTradeBalanceIndex };