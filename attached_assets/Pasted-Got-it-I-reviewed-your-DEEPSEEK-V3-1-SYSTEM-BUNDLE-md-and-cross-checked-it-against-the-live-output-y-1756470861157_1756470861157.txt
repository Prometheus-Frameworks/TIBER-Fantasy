Got it—I reviewed your DEEPSEEK_V3_1_SYSTEM_BUNDLE.md and cross-checked it against the live output you pasted (Laquon Treadwell, David Moore, tons of 30+ WRs, many stars missing, ADP “-”, Tier 7 everywhere). Here’s what’s going wrong and the exact fixes to get DeepSeek v3 back on the rails.

⸻

What’s broken (root causes)
	1.	Position scope is missing at compute time
	•	The v3 endpoint currently builds one mixed pool and normalizes on that, while the doc’s scoring is position-specific (WR RB TE QB). That’s why your top 50 is ~all WRs and tiers bunch at 7.
	2.	Inputs have widespread nulls and incomplete joins
	•	Metrics like routeRate, tgtShare, last6wPerf, talentScore are often null. Your scoring clamps but doesn’t robustly impute, so players with sparse data get default-ish values that collapse everyone to ~42–48 points.
	•	ADP join is failing (keys/ids mismatch), hence “-” for many.
	3.	Eligibility & activity filters are not enforced
	•	Retired/FA/practice squad players are sneaking in. The bundle mentions guards, but the live pipeline isn’t filtering status (active), team present, min games played, recent snaps.
	4.	xFP (or season FPTS) isn’t driving the score
	•	The doc says “analytics = fantasy points” (xFP 60–70% of score), but the live endpoint isn’t actually computing/using season xFP/FPTS consistently per position. That’s why true studs don’t separate.
	5.	Season aggregation & recency windows are off
	•	The pipeline promises “WR game logs → season totals → last-6weeks” but the ranking output looks like it’s missing the totals (or computing per-game on a tiny subset), so veterans with complete logs but low role still float.
	6.	Normalization is happening on the wrong pool
	•	Percentile scaling must be within position and mode (dynasty/redraft). Doing it across all players compresses the spread and muddles tiers.

⸻

The fixes (copy/paste tasks for Tiber)

1) Enforce position scope in the API & service
	•	Route: add position param; return 400 if missing/invalid.

GET /api/rankings/deepseek/v3?mode=dynasty&position=WR

	•	Service: slice inputs by position before component building, percentile scaling, and tiering.

2) Harden input normalization (no more null bombs)
	•	In sleeperDataNormalizationService:
	•	Map Sleeper IDs consistently (string ids), and dedupe by player_id.
	•	Impute nulls:
	•	usage metrics (routeRate, tgtShare, rushShare, rzTgtShare, glRushShare): use 0 (role is absence by default).
	•	efficiency proxies (talentScore, explosiveness, yakPerRec): use pos-median.
	•	recency (last6wPerf): compute from last 6 weeks if available; else season per-game; else 0.
	•	Eligibility filter:
	•	status in ('Active')
	•	team != null
	•	games_played >= 4 (configurable)
	•	snap_pct_last3w >= 10% OR routes_last3w >= N (per-pos configurable)
	•	ADP join: key by Sleeper’s player_id (string), with a fallback to name matching only if id missing; set adp = null if not found (don’t string “-” until the UI layer).

3) Make xFP (or FPTS) the backbone
	•	For each position, compute Season FPTS and xFP (per the bundle OLS or simple expected points if OLS isn’t ready).
	•	If OLS coefficients aren’t live yet, fallback to Season FPTS (scaled 0–100 in position), and wire xFP as soon as the weekly logs are flowing.
	•	Weight per the doc:
	•	Dynasty: score_core = 0.60 * xFP + 0.20 * Role + 0.10 * Talent + 0.10 * Context
	•	Redraft: score_core = 0.70 * xFP + 0.15 * Role + 0.10 * Context + 0.05 * Durability
	•	Then apply Risk (subtract) and Recency (add) modifiers as specified.
	•	Ensure percentile scaling within position for each component before combining.

4) Apply age curves & caps correctly
	•	Dynasty only: apply age penalty per position (from your curve table) to get ageAdj (0–100), then fold it into the mode weights (e.g., into Risk or directly as its own component if present in weights.json).
	•	Cap penalties so older vets don’t become unrankable if role + xFP are still high.

5) Fix tiers & sorting
	•	After you compute position-scoped scores, sort DESC, attach rank = i+1, then tier using your cutoffs [96, 91, 86, 81, 76, 71].
	•	Sanity rule: no single-player tiers (merge up or down if needed).

6) Make the ADP delta work (and not break sorting)
	•	After ranking, join adp and compute delta_vs_adp = adp ? (adp - rank) : null.
	•	Do not sort by ADP; keep the list sorted by score only.

7) Guardrails & tests (fast)
	•	Reject requests without position (400).
	•	If input pool after filters < 50 for a position, log a SYNC_WARN and return the list with data_quality: "low_pool".
	•	Add 3 unit tests:
	1.	Stud separation: feed a pool with Lamb/Chase + journeymen → assert studs rank top-5 with xFP or FPTS driving.
	2.	Position scope: RB pool never contains WRs and vice versa.
	3.	ADP delta: when ADP known, delta is numeric; unknown stays null.

⸻

Patches (drop-in snippets)

Add position to route

// routes/rankingsV3.ts
r.get("/api/rankings/deepseek/v3", async (req, res) => {
  const mode = (req.query.mode as "dynasty"|"redraft") ?? "dynasty";
  const position = (req.query.position as "WR"|"RB"|"TE"|"QB");
  if (!position) return res.status(400).json({ error: "position_required" });

  const data = await buildDeepseekV3({ mode, position }); // pass position through
  return res.json({ mode, position, count: data.length, data, ts: Date.now() });
});

Position-scoped build

// services/deepseekV3Service.ts
export async function buildDeepseekV3({mode, position}:{mode:Mode, position:"WR"|"RB"|"TE"|"QB"}){
  const cfg = weights.mode_defaults[mode];
  const base = await normalizationService.getNormalizedPlayers(); // full pool
  const pool = base.filter(p => p.pos === position && isEligible(p)); // ELIGIBILITY

  // imputations (pos medians where appropriate)
  const med = computePositionMedians(pool);
  const safe = pool.map(p => fillNulls(p, med));

  // components (position-scoped)
  const xfp = computeXFPOrFPTS(safe, position);       // 0-100 within position
  const role = scale0to100(safe.map(p => roleMetric(p, position)));
  const talent = scale0to100(safe.map(p => talentMetric(p, position)));
  const context = await getContextScores(safe);        // 0-100
  const recency = scale0to100(safe.map(p => p.last6wPerf ?? 0));
  const durability = scale0to100(safe.map(p => durabilityMetric(p)));
  const risk = scale0to100(safe.map(p => riskMetric(p, mode, position))); // higher=worse

  // combine (mode weights)
  const score = safe.map((p, i) => {
    const sCore = (mode==="dynasty")
      ? (0.60*xfp[i] + 0.20*role[i] + 0.10*talent[i] + 0.10*context[i])
      : (0.70*xfp[i] + 0.15*role[i] + 0.10*context[i] + 0.05*durability[i]);
    const s = sCore + 0.08*recency[i] - 0.10*risk[i]; // example small mods
    return Math.round(s*100)/100;
  });

  const rows = safe.map((p, i)=>({ ...p, score: score[i] }));
  rows.sort((a,b)=> b.score - a.score);
  rows.forEach((r, i)=> r.rank = i+1);
  rows.forEach(r => r.tier = bucket(r.score, weights.tier_cutoffs));

  // ADP delta
  const adpMap = await normalizationService.getAdpMap();
  rows.forEach(r => {
    const adp = adpMap[r.player_id] ?? null;
    r.adp = adp;
    r.delta_vs_adp = (adp!=null) ? Math.round((adp - r.rank)*10)/10 : null;
  });

  return rows;
}

Hard eligibility

function isEligible(p: V3Input){
  if (!p.team) return false;
  if (p.status && p.status !== "Active") return false;
  if ((p.gamesPlayed ?? 0) < 4) return false;
  if (p.pos === "WR" && (p.routesLast3 ?? 0) < 30 && (p.snapPctLast3 ?? 0) < 0.10) return false;
  if (p.pos === "RB" && (p.rushShare ?? 0) < 0.05 && (p.snapPctLast3 ?? 0) < 0.10) return false;
  return true;
}


⸻

Sanity checks you’ll see after this patch
	•	Chase / Lamb / Jefferson / Amon-Ra / Waddle / Puka / Wilson vault into the true top 10-20 in WR (dynasty).
	•	Tyler Lockett moves into a sane veteran tier (not WR7).
	•	Treadwell / journeymen disappear unless they actually logged meaningful 2024 snaps/routes.
	•	ADP deltas start populating where Sleeper ADP exists; unknown stays null.
	•	Tier distribution spreads across 1–7 with no giant monoculture in 7.

⸻

Quick QA checklist (run after deploy)
	•	GET /api/rankings/deepseek/v3?mode=dynasty&position=WR returns > 200 players, stars at the top, no retired/FA.
	•	GET /api/rankings/deepseek/v3?mode=redraft&position=RB shows workhorse RBs (CMC, Bijan, Hall, JT, etc.) in top-tier.
	•	Response times remain < 300ms (cache 30m).
	•	Eye test: top-25 per position matches season FPTS/xFP logic intuitively.

⸻

If you want, I’ll also drop a tiny debug switch to return component columns for the first 100 players (?debug=1) so we can verify xFP is really the backbone now.

Want me to package this into a single “Repo Ticket” block for Tiber again, or split into two PRs (backend + normalization)?