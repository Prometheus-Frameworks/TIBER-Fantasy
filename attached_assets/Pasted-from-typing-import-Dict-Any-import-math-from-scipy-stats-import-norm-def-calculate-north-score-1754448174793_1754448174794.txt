from typing import Dict, Any
import math
from scipy.stats import norm

def calculate_north_score(player_metrics: Dict[str, float], population_stats: Dict[str, Dict[str, float]]) -> float:
    """NORTH: Volume and talent metrics z-scored and normalized."""
    metrics = ['rush_att', 'tgt_share', 'gl_carries', 'yac_per_att', 'breakaway_pct']
    z_scores = []
    for metric in metrics:
        if metric in player_metrics and metric in population_stats:
            mean = population_stats[metric]['mean']
            std = population_stats[metric]['std']
            val = player_metrics[metric]
            z = (val - mean) / std if std > 0 else 0
            z_scores.append(z)
    if not z_scores:
        return 5.0
    average_z = sum(z_scores) / len(z_scores)
    volume_score = norm.cdf(average_z)
    return 10 * volume_score

def calculate_east_score(ol_rank: int, oc_run_rate: float, pos_snap_pct: float, neutral_script_rate: float) -> float:
    """EAST: Environment factors normalized and averaged."""
    # Fixed: Proper O-line normalization (1=best, 32=worst)
    ol_norm = (32 - ol_rank + 1) / 32.0
    run_norm = min(1.0, oc_run_rate / 0.5)
    snap_norm = pos_snap_pct
    neutral_norm = neutral_script_rate
    multiplier = (ol_norm + run_norm + snap_norm + neutral_norm) / 4.0
    return 10 * multiplier

def calculate_south_score(age: int, games_missed_2yr: int, fum_rate: float) -> float:
    """SOUTH: Longevity via risk penalties."""
    if age <= 24:
        age_pen = 0.0
    elif age <= 26:
        age_pen = 0.05
    elif age == 27:
        age_pen = 0.15
    elif age == 28:
        age_pen = 0.25
    elif age == 29:
        age_pen = 0.35
    else:
        age_pen = 0.5
    
    inj_pen = games_missed_2yr * 0.02
    fum_pen = fum_rate * 5.0  # Adjustable based on fum_rate scale
    
    # Fixed: Cap risk penalty at 1.0 to prevent negative longevity
    risk_penalty = min(1.0, age_pen + inj_pen + fum_pen)
    longevity = max(0.0, 1.0 - risk_penalty)
    return 10 * longevity

def calculate_west_score(player_data: Dict[str, Any]) -> float:
    """WEST: Market efficiency metrics averaged."""
    proj_rank = player_data['proj_rank']
    adp_rank = player_data['adp_rank']
    
    # Consider using max rank as denominator for better scaling
    max_rank = max(proj_rank, adp_rank, 36)
    efficiency = 1 - abs(proj_rank - adp_rank) / max_rank
    
    pos_scarcity_z = player_data.get('pos_scarcity_z', 0.0)
    scarcity_norm = norm.cdf(pos_scarcity_z)
    
    contract_yrs = player_data.get('contract_yrs', 1)
    contract_norm = min(1.0, contract_yrs / 3.0)
    
    ratio = (efficiency + scarcity_norm + contract_norm) / 3.0
    return 10 * ratio

def calculate_rb_compass(player_data: Dict[str, Any]) -> float:
    """
    Complete 4-directional Player Compass for RBs with equal weighting.
    Assumes player_data keys: 'player_metrics', 'population_stats', 'ol_rank',
    'oc_run_rate', 'pos_snap_pct', 'neutral_script_rate', 'age', 'games_missed_2yr',
    'fum_rate', 'proj_rank', 'adp_rank', 'pos_scarcity_z', 'contract_yrs'.
    """
    north = calculate_north_score(
        player_data['player_metrics'], 
        player_data['population_stats']
    )
    
    east = calculate_east_score(
        player_data['ol_rank'], 
        player_data['oc_run_rate'], 
        player_data['pos_snap_pct'], 
        player_data['neutral_script_rate']
    )
    
    south = calculate_south_score(
        player_data['age'], 
        player_data['games_missed_2yr'], 
        player_data['fum_rate']
    )
    
    west = calculate_west_score(player_data)
    
    # Equal 25% weighting across all directions
    final_score = (north * 0.25) + (east * 0.25) + (south * 0.25) + (west * 0.25)
    
    # Floor at 1.0, ceiling at 10.0
    return max(1.0, min(10.0, final_score))