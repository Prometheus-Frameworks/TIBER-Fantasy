from typing import Dict, List

# Predefined mappings for modifiers
CONTEXT_TAG_MODIFIERS: Dict[str, float] = {
    "elite": 0.3,
    "breakout": 0.2,
    "sleeper": 0.1,
    "injury_prone": -0.2,
    "bust_risk": -0.1,
    "depth_chart_riser": 0.1,
    # Add more tags as needed; keeps maintainability high
}

INJURY_LEVEL_MODIFIERS: Dict[str, float] = {
    "low": 0.0,
    "medium": -0.1,
    "high": -0.3,
}

CONTRACT_STATUS_MODIFIERS: Dict[str, float] = {
    "long_term": 0.2,
    "medium_term": 0.1,
    "expiring": -0.2,
}

COMPETITION_LEVEL_MODIFIERS: Dict[str, float] = {
    "low": 0.2,
    "medium": 0.0,
    "high": -0.2,
}

def calculate_tier_score(anchor_score: float) -> float:
    """Base tier from anchor, normalized by division."""
    return anchor_score / 12.0

def calculate_context_modifiers(context_tags: List[str]) -> float:
    """Sum small modifiers from context tags."""
    return sum(CONTEXT_TAG_MODIFIERS.get(tag, 0.0) for tag in context_tags)

def calculate_scenario_average(rebuilder_score: float, contender_score: float) -> float:
    """Average of scenario-specific scores."""
    return (rebuilder_score + contender_score) / 2.0

def calculate_age_modifier(age: int) -> float:
    """Age-based modifier with variance for youth/age spread."""
    if age < 25:
        return 0.5
    elif age < 28:
        return 0.3
    elif age < 30:
        return 0.0
    elif age < 33:
        return -0.3
    else:
        return -0.5

def calculate_key_insight_modifiers(
    age: int,
    injury_level: str,
    contract_status: str,
    competition_level: str
) -> float:
    """Sum modifiers from key insights."""
    age_mod = calculate_age_modifier(age)
    injury_mod = INJURY_LEVEL_MODIFIERS.get(injury_level, 0.0)
    contract_mod = CONTRACT_STATUS_MODIFIERS.get(contract_status, 0.0)
    competition_mod = COMPETITION_LEVEL_MODIFIERS.get(competition_level, 0.0)
    return age_mod + injury_mod + contract_mod + competition_mod

def calculate_dynasty_score(player_data: Dict[str, any]) -> float:
    """
    Compute final dynasty score from four components.
    Assumes player_data keys: 'anchor_score', 'context_tags', 'rebuilder_score',
    'contender_score', 'age', 'injury_level', 'contract_status', 'competition_level'.
    Final combines base tier and scenario avg, then adds mods for variance.
    Trade-off: Additive mods increase spread but risk outlier extremes; cap if needed.
    """
    tier_score = calculate_tier_score(player_data["anchor_score"])
    context_mod = calculate_context_modifiers(player_data["context_tags"])
    scenario_avg = calculate_scenario_average(player_data["rebuilder_score"], player_data["contender_score"])
    insight_mod = calculate_key_insight_modifiers(
        player_data["age"],
        player_data["injury_level"],
        player_data["contract_status"],
        player_data["competition_level"]
    )
    # Average core scores, add mods; scales to ~0-10 with variance
    base_score = (tier_score + scenario_avg) / 2.0
    final_score = base_score + context_mod + insight_mod
    return max(0.0, min(10.0, final_score))  # Clamp for data safety and realistic scaling