You are working in the TIBER-Fantasy repo. I tried to manually add a Jest test script and broke package.json JSON formatting. I need you to do the following carefully and then report back:

Fix package.json JSON formatting

Open package.json.

Ensure it is valid JSON (no trailing commas, correct commas between properties).

Under "scripts", add a new script:

"test:forge": "NODE_OPTIONS=--experimental-vm-modules jest --config jest.config.cjs --runInBand server/modules/forge/__tests__/recursiveAlphaEngine.test.ts"


Preserve all existing scripts and config, only add this new one and fix commas as needed.

Ensure Jest config exists

At the repo root, ensure there is a file named jest.config.cjs with the following contents:

module.exports = {
  preset: 'ts-jest/presets/default-esm',
  testEnvironment: 'node',
  extensionsToTreatAsEsm: ['.ts'],
  moduleNameMapper: {
    '^(\\.{1,2}/.*)\\.js$': '$1',
  },
  globals: {
    'ts-jest': {
      useESM: true,
    },
  },
};


Ensure the FORGE test file exists

Under server/modules/forge/, create a folder __tests__ if it does not exist.

Inside that folder, create recursiveAlphaEngine.test.ts with this content:

import { calculateRecursiveAlpha, RecursiveScoringOptions } from '../recursiveAlphaEngine';
import { calculateAlphaScore } from '../alphaEngine';
import {
  getPreviousWeekState,
  saveForgeState,
  calculateVolatility,
} from '../forgeStateService';
import { ForgeContext, ForgeFeatureBundle } from '../types';

jest.mock('../alphaEngine', () => ({
  calculateAlphaScore: jest.fn(),
}));

jest.mock('../forgeStateService', () => {
  const actual = jest.requireActual('../forgeStateService');
  return {
    ...actual,
    getPreviousWeekState: jest.fn(),
    saveForgeState: jest.fn(),
  };
});

const baseContext: ForgeContext = {
  playerId: 'player-1',
  playerName: 'Test Player',
  position: 'WR',
  nflTeam: 'FA',
  season: 2024,
  asOfWeek: 2,
  age: 26,
  gamesPlayed: 1,
  dataQuality: {
    hasAdvancedStats: true,
    hasSnapData: true,
    hasDvPData: true,
    hasEnvironmentData: true,
    cappedDueToMissingData: false,
  },
  scoredAt: new Date(),
  subScores: {
    volume: 70,
    efficiency: 70,
    stability: 70,
    contextFit: 70,
  },
  alpha: 75,
  trajectory: 'flat',
  confidence: 90,
};

const baseFeatures: ForgeFeatureBundle = {
  position: 'WR',
  gamesPlayed: 1,
  volumeFeatures: { raw: {}, normalized: {}, score: 70 },
  efficiencyFeatures: { raw: {}, normalized: {}, score: 70, capped: false },
  stabilityFeatures: { weeklyPpgStdDev: 5, floorWeekRate: 0.5, boomWeekRate: 0.2, score: 70 },
  contextFitFeatures: { raw: {}, normalized: {}, score: 70, isNeutral: false },
  dataQuality: {
    hasAdvancedStats: true,
    hasSnapData: true,
    hasDvPData: true,
    hasEnvironmentData: true,
  },
};

const scoringOptions: RecursiveScoringOptions = { persistState: false };

const alphaMock = calculateAlphaScore as jest.MockedFunction<typeof calculateAlphaScore>;
const previousStateMock = getPreviousWeekState as jest.MockedFunction<typeof getPreviousWeekState>;
const saveStateMock = saveForgeState as jest.MockedFunction<typeof saveForgeState>;

beforeEach(() => {
  jest.clearAllMocks();

  alphaMock.mockResolvedValue({
    ...baseContext,
    subScores: baseContext.subScores,
    alpha: 82,
    rawAlpha: 82,
  });

  previousStateMock.mockResolvedValue({
    alphaPrev: 70,
    tierPrev: 2,
    volatilityPrev: 4,
    momentum: 6,
    alphaHistory: [70, 68, 72],
  });

  saveStateMock.mockResolvedValue();
});

test('returns only finite alpha outputs (no NaN or Infinity)', async () => {
  const score = await calculateRecursiveAlpha({ ...baseContext }, baseFeatures, scoringOptions);

  expect(Number.isFinite(score.alpha)).toBe(true);
  expect(Number.isFinite(score.recursion.pass0Alpha)).toBe(true);
  expect(Number.isFinite(score.recursion.pass1Alpha)).toBe(true);
});

test('stability and volatility modifiers stay within +/-30% of raw alpha by default', async () => {
  const score = await calculateRecursiveAlpha({ ...baseContext }, baseFeatures, scoringOptions);

  const rawAlpha = score.recursion.pass0Alpha;
  const adjustedAlpha = score.recursion.pass1Alpha;
  const delta = adjustedAlpha - rawAlpha;
  const allowedRange = Math.abs(rawAlpha * 0.3);

  expect(delta).toBeGreaterThanOrEqual(-allowedRange);
  expect(delta).toBeLessThanOrEqual(allowedRange);

  const volatility = calculateVolatility([
    adjustedAlpha,
    ...(previousStateMock.mock.calls.length ? [70, 68, 72] : []),
  ]);
  if (volatility !== null) {
    expect(volatility).toBeLessThanOrEqual(Math.abs(rawAlpha * 0.3));
  }
});

test('handles missing or partial player data by falling back to safe defaults', async () => {
  previousStateMock.mockResolvedValue(null);
  alphaMock.mockResolvedValue({
    ...baseContext,
    playerName: 'Partial Player',
    nflTeam: undefined,
    subScores: baseContext.subScores,
    alpha: 60,
    rawAlpha: 60,
    gamesPlayed: 0,
  });

  const score = await calculateRecursiveAlpha(
    {
      playerId: baseContext.playerId,
      playerName: 'Partial Player',
      position: 'WR',
      season: 2024,
      asOfWeek: 1,
      gamesPlayed: 0,
      subScores: baseContext.subScores,
      alpha: 0,
      trajectory: 'flat',
      confidence: 0,
      dataQuality: baseContext.dataQuality,
      scoredAt: new Date(),
    },
    { ...baseFeatures, gamesPlayed: 0 },
    scoringOptions,
  );

  expect(score.recursion.isFirstWeek).toBe(true);
  expect(score.recursion.expectedAlpha).toBeGreaterThan(0);
  expect(score.alpha).toBeGreaterThan(0);
});


Install dev dependencies if missing

Ensure jest, ts-jest, and @types/jest are present under devDependencies in package.json. If not, add them with reasonable recent versions.

Run the tests

Run:

npm install
npm run test:forge


If tests fail, fix any import path or config issues necessary for this single test file to run cleanly without changing core FORGE business logic.

Finally, summarize

Tell me:

Which files you created or modified.

The final scripts section from package.json.

The test run result (npm run test:forge).