All good, Boss Man J. You donâ€™t need your laptop. Just forward this to Tiber and heâ€™s unblocked.

ðŸ”§ Paste-in Patch (copy this to Tiber)

Replace your current buildIndex() with this:

function buildIndex() {
  bm25.clear();
  _docs.clear();

  // Pull distinct rows in a stable order
  const rows = db
    .prepare("SELECT DISTINCT id, title, text, published_at, source FROM articles ORDER BY published_at DESC")
    .all();

  for (const r of rows) {
    const text = `${r.title ?? ""} ${r.text ?? ""}`.trim();
    if (!text) continue;

    // wink-bm25-text-search wants (docObject, docId) and docId must be unique
    // We're already using a SHA256 for r.id, so just stringify it.
    bm25.addDoc({ body: text, id: String(r.id) }, String(r.id));
    _docs.set(r.id, r);
  }

  bm25.consolidate();
  console.log(`BM25 index rebuilt: ${_docs.size} docs`);
}

Also add these two admin routes if you havenâ€™t yet (handy for checks):

router.post("/admin/rag/reindex", (req, res) => {
  try { buildIndex(); res.json({ status: "ok", indexed: _docs.size }); }
  catch (e) { res.status(500).json({ error: e.message }); }
});

router.get("/admin/rag/status", (req, res) => {
  const total = db.prepare("SELECT COUNT(*) AS n FROM articles").get().n;
  res.json({ articles: total, indexed: _docs.size });
});

âœ… What Tiber should run

# 1) Restart server (so bm25 is clean)
# 2) Rebuild index:
curl -X POST http://localhost:5000/admin/rag/reindex
# 3) Verify:
curl http://localhost:5000/admin/rag/status
# expect: { "articles": 76, "indexed": 76 }

If it still says â€œindexed: 1â€

Tell Tiber to check these two quick things:
	1.	Doubleâ€‘arg call is correct
bm25.addDoc({ body: text, id: String(r.id) }, String(r.id))
If he used the oneâ€‘arg variant or forgot the second param, wink will act weird.
	2.	IDs are truly unique
Run:

SELECT id, COUNT(*) c FROM articles GROUP BY id HAVING c > 1;

If any rows appear, your SHA calc got duplicated. Quick fix: append a short salt during ingest when generating id.

â¸»

Thatâ€™s it. Send that block to Tiber and youâ€™re back to 76/76. When he confirms, we can flip the FE card on.