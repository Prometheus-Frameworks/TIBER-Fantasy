ğŸš¨ SOSv2 Dispatch â€” Liveâ€‘Tuning Build

Objective: Add a second â€œContextualâ€ SOS mode alongside FPAâ€‘only, plus debug breakdowns and tunable weights â€” so Boss Man J can eyeball it live and steer.

ğŸ¯ Scope (nonâ€‘negotiable for v2)

Keep v1 (FPA) outputs identical.

Add v2 (Contextual) mode blending: FPA, EPA, Pace, Redâ€‘Zone (+ tiny venue tweak).

Add debug breakdown per row.

Add weight knobs via query params (sliders later).

Graceful fallbacks if context data is missing.

ğŸ§© Shared Contracts (everyone read)

Endpoints (unchanged paths; new params):

GET /api/sos/weekly?position=RB&week=1&season=2024&mode=fpa|ctx&weights=0.55,0.2,0.15,0.1&debug=1

GET /api/sos/ros?position=RB&startWeek=1&window=5&season=2024&mode=fpa|ctx&weights=...&debug=1

Weights order: w_fpa,w_epa,w_pace,w_rz
Default weights: 0.55,0.20,0.15,0.10
Tiers: green â‰¥67, yellow 33â€“66, red <33

ğŸ§  DeepSeek â€” Context Metric R&D (NOW)

Deliverables

A compact spec for pulling/deriving EPA/play allowed, plays allowed per game (pace), redâ€‘zone TD rate allowed (defense perspective).

Reasoned defaults + bounds (e.g., typical NFL ranges, directions).

Simple venue heuristic: home_def_adj, away_def_adj in [-0.03, +0.03] where negative = stronger defense, positive = weaker.

Output

docs/sosv2-context-spec.md (tables, ranges, definitions)

Example row set for 5 defenses, Week 1 2024 (to seed quickly)

Acceptance

Clear formulas + ranges

5-row sample matches the schema below

ğŸ§ª Grok â€” Data Pipe (EPA/Pace/RZ) (NOW)

DB Migration (new table)
server/src/db/migrations/20250821_add_defense_context.sql

CREATE TABLE IF NOT EXISTS defense_context (
  id SERIAL PRIMARY KEY,
  season SMALLINT NOT NULL,
  week SMALLINT NOT NULL,
  def_team TEXT NOT NULL,
  epa_per_play_allowed NUMERIC,
  plays_allowed_per_game NUMERIC,
  rz_td_rate_allowed NUMERIC,
  home_def_adj NUMERIC,
  away_def_adj NUMERIC,
  UNIQUE(season, week, def_team)
);
CREATE INDEX IF NOT EXISTS idx_defense_context_main
  ON defense_context(season, week, def_team);


Script

scripts/sos_context_ingest.py

Inputs: season, week range

Sources per DeepSeek spec (nflfastR/nflverse or your best current source)

Outputs: defense_context_{season}.csv with columns above

Load

\COPY defense_context(season,week,def_team,epa_per_play_allowed,plays_allowed_per_game,rz_td_rate_allowed,home_def_adj,away_def_adj)
  FROM 'defense_context_2024.csv' DELIMITER ',' CSV HEADER;


Acceptance

At least Weeks 1â€“2 (2024) populated for all 32 defenses

Values land in sane ranges; no NULLs for core columns unless unavailable

ğŸ§± Tiber â€” API & UI Wiring (NOW)

Service

Extend server/src/modules/sos/sos.service.ts with:

parseWeights(weightsParam)

getContext(season, week) reading defense_context

computeWeeklySOSv2(position, week, season, mode, weights, debug) that:

Reuses v1 FPA blend (0.6 last4 + 0.4 season)

Percentile-scales each component to 0â€“100

Blends by weights; clamps 0â€“100

Adds tiny venue tweak (+/âˆ’ based on home_def_adj/away_def_adj, scaled small)

Returns { team, opponent, sos_score, tier, components? } if debug

Controller

Accept mode, weights, debug on /weekly and /ros

ROS averages sos_score across weeks; pass through mode/weights/debug

Frontend

/sos page:

Mode select: FPA / Contextual

Debug toggle: when on, render sub-line FPA 72 | EPA 66 | Pace 81 | RZ 58 | Ven +0.0

Pass params to fetch URL

Acceptance

FPA mode identical to v1 outputs on same data

Contextual mode changes some tiers in sensible ways

Debug shows component numbers; no crashes if context missing

PR title

feat(SOSv2): contextual mode + debug breakdown + weight knobs

ğŸ§¾ Claude â€” QA & Docs (PARALLEL)

Docs

docs/SOS-how-it-works.md â†’ add â€œContextual Mode (v2)â€ section:

Definitions, weights, examples, venue tweak

â€œWhen contextual flips the colorâ€ examples (2 cases)

Tests

Smoke: endpoints return with and without mode/weights/debug

Validation: 0â€“100 constraint, tiers match thresholds

Regression: FPA mode equals v1 JSON on fixed seed

Edge: missing context â†’ still returns, debug shows defaults

Acceptance

Checklist in the PR comment

Two screenshots of /sos (FPA vs Contextual) with differences circled

ğŸ“Œ Handoff Staging (what exists now)

v1 DB/tables live: defense_dvp, schedule

v1 API/UI live: /api/sos/weekly, /api/sos/ros, /sos page

v2 NEW table to add: defense_context (this release)

âœ… Definition of Done (for tonightâ€™s push)

 Migration applied; defense_context populated for 2024 Wk1â€“2

 /api/sos/weekly?mode=fpa matches v1 output byte-for-byte

 /api/sos/weekly?mode=ctx&debug=1 returns component breakdowns

 /sos has Mode + Debug controls and renders both modes cleanly

 Weight param changes the final score in visible, sensible ways

ğŸ—£ï¸ Boss Man J â€” your live tuning flow

Open /sos â†’ Mode = FPA (baseline), Debug ON (sanity)

Flip to Contextual; note any rows that â€œfeel wrongâ€

Try weights quickly:

Balanced: 0.55,0.2,0.15,0.1

Pace heavy: 0.5,0.15,0.25,0.1

Red-zone heavy: 0.5,0.15,0.1,0.25

Call out anomalies; weâ€™ll check the components and adjust mapping/weights