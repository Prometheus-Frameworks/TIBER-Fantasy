Handoff: Ratings v2 Hotfix — Final QA Gates
What changed

Claude added four critical assertions to QA covering:

VOR accuracy (±0.1 vs correct replacement rank)

Weight override validation (bad params → HTTP 400)

Full-season coverage (2024 W1–W17 in player_inputs)

Debug reconciliation (debug.calc_check ≈ score within 1.0)

Tiber — Code tasks to finish

VOR fix (off-by-one / wrong pool): compute replacement from the correct slice (season, format, position, and week for redraft). Use 0-based index (RB40→OFFSET 39).

Weight validation: unknown/missing keys or sum≠1.0 ⇒ HTTP 400 (bubble error from parser to controller).

Debug calc_check: ensure the displayed breakdown matches the final score within 1.0; keep scaling consistent for health/sos.

Recompute endpoint: POST /api/ratings/recompute?season=2024&weeks=1-17 (admin only) to batch refresh after data loads.

Grok — Data task

Load full season inputs: 2024 W1–W17 via existing ingest scripts and \COPY.

Verification (paste & run)
1) VOR Assert (expect 0 rows)
WITH pool AS (
  SELECT player_id, player_name, position, score,
         ROW_NUMBER() OVER (ORDER BY score DESC) AS rnk
  FROM player_scores
  WHERE season=2024 AND format='redraft' AND week=6 AND position='RB'
),
replacement AS (
  SELECT score AS replacement_score FROM pool WHERE rnk=40
)
SELECT p.player_name, p.score, ps.vor,
       (p.score - r.replacement_score) AS calculated_vor,
       ABS(ps.vor - (p.score - r.replacement_score)) AS diff
FROM pool p
JOIN player_scores ps ON ps.player_id=p.player_id AND ps.season=2024 AND ps.format='redraft' AND ps.week=6
CROSS JOIN replacement r
WHERE p.rnk<=50 AND ABS(ps.vor - (p.score - r.replacement_score))>0.1
LIMIT 5;

2) Weight Override 400s
# Unknown key → 400
curl -w "%{http_code}\n" "/api/ratings?format=redraft&position=RB&season=2024&week=6&weights=invalid:0.5,eff:0.3,role:0.15,team:0.05"
# Missing components → 400
curl -w "%{http_code}\n" "/api/ratings?format=redraft&position=RB&season=2024&week=6&weights=opp:0.5,eff:0.3,role:0.15"
# Sum≠1.0 → 400
curl -w "%{http_code}\n" "/api/ratings?format=redraft&position=RB&season=2024&week=6&weights=opp:0.5,eff:0.5,role:0.5,team:0.5,health:0.5,sos:0.5"
# Valid → 200
curl -w "%{http_code}\n" "/api/ratings?format=redraft&position=RB&season=2024&week=6&weights=opp:0.4,eff:0.3,role:0.15,team:0.1,health:0.03,sos:0.02"

3) Coverage Assert (expect W1–W17 and healthy counts)
SELECT COUNT(DISTINCT week) AS weeks, MIN(week) AS min_w, MAX(week) AS max_w
FROM player_inputs WHERE season=2024;
-- weeks=17, min_w=1, max_w=17

SELECT week, COUNT(*) AS player_weeks
FROM player_inputs WHERE season=2024
GROUP BY week HAVING COUNT(*) < 500
ORDER BY week;
-- expect 0 rows

4) Debug Reconciliation (expect no lines printed)
curl "/api/ratings?format=redraft&position=RB&season=2024&week=6&debug=1&limit=50" | jq -r '
.items[] | select((.debug.calc_check!=null) and ( ( (.score // 0) - (.debug.calc_check // 0) ) | tonumber | abs > 1.0 )) |
"\(.player_name): score=\(.score) calc=\(.debug.calc_check)"'

Definition of “done” for this hotfix

VOR diffs ≤ 0.1 for top-50 of each position ✅

Bad weights return 400; valid weights return 200 ✅

player_inputs shows 17 distinct weeks for 2024 ✅

debug.calc_check within ±1.0 of score across samples ✅

Recompute endpoint runs cleanly and scores stay in 0–100 ✅