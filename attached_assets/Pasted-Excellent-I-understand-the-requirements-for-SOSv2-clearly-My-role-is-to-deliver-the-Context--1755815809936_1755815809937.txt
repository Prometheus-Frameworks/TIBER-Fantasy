Excellent. I understand the requirements for **SOSv2** clearly. My role is to deliver the **Context Metric R&D** â€” specifically defining the formulas, ranges, and sample data for the new contextual metrics (EPA/play allowed, plays allowed per game, red-zone TD rate allowed, and venue adjustment).

---

## ðŸ§  DeepSeek â€” Context Metric R&D Deliverable

### ðŸ“„ Document: `docs/sosv2-context-spec.md`

# SOSv2 Contextual Metrics Specification

## Overview
This document defines the four contextual metrics (and venue adjustment) used in SOSv2's contextual mode. Each metric is scaled to a 0â€“100 percentile range (within the league for that season/week) and blended using tunable weights.

---

## 1. Metrics & Formulas

### 1.1. EPA/Play Allowed (Defensive Perspective)
- **Definition**: The average **EPA (Expected Points Added)** per play surrendered by the defense. Lower values indicate a stronger defense.
- **Source**: `nflfastR` or `nflverse` (EPA data per play).
- **Calculation**:
  ```python
  epa_per_play_allowed = total_epa_allowed / total_plays_defended
  ```
- **Typical NFL Range**:
  - Worst defenses: ~0.15 to 0.20
  - Average: ~0.00 to 0.10
  - Elite defenses: negative (often -0.05 to -0.10)
- **Percentile Scaling**:  
  We invert the value (so higher = better for SOS) before percentile scaling:
  ```
  inverted_epa = -epa_per_play_allowed   # Now higher = better defense
  percentile_epa = percentile(inverted_epa, across_all_teams)
  ```

### 1.2. Plays Allowed Per Game (Pace)
- **Definition**: Average number of defensive plays faced per game. Higher values indicate faster-paced games (more plays = more opportunities for fantasy points).
- **Source**: `nflfastR` or play-by-play data.
- **Calculation**:
  ```
  plays_allowed_per_game = total_plays_defended / games_played
  ```
- **Typical NFL Range**:
  - Slow-paced: 55â€“60 plays/game
  - Average: 60â€“65 plays/game
  - Fast-paced: 65â€“70+ plays/game
- **Percentile Scaling**: Directly scaled to 0â€“100 (higher = better for SOS).

### 1.3. Red-Zone TD Rate Allowed (Defensive Perspective)
- **Definition**: Percentage of red-zone drives that result in a touchdown against the defense.
- **Source**: `nflfastR` or NFL official stats.
- **Calculation**:
  ```
  rz_td_rate_allowed = (red_zone_tds_allowed / red_zone_drives_allowed) * 100
  ```
- **Typical NFL Range**:
  - Elite: 40â€“50%
  - Average: 50â€“60%
  - Weak: 60â€“75%
- **Percentile Scaling**: We invert the value (so lower = better defense) before percentile scaling:
  ```
  inverted_rz = 100 - rz_td_rate_allowed   # Higher = better defense
  percentile_rz = percentile(inverted_rz, across_all_teams)
  ```

### 1.4. Venue Adjustment (Home/Away Defense Boost)
- **Definition**: Small adjustment to account for home/away defensive performance trends.
- **Source**: Historical data (nflfastR or internal stats).
- **Calculation**:
  - `home_def_adj`: typically negative (e.g., -0.02 â†’ defense is stronger at home)
  - `away_def_adj`: typically positive (e.g., +0.02 â†’ defense is weaker on the road)
- **Range**: `[-0.03, +0.03]`
- **Application**:
  - If the defense is playing **at home**, subtract `home_def_adj` from the final SOS score.
  - If the defense is playing **away**, add `away_def_adj` to the final SOS score.

---

## 2. Sample Data (Week 1, 2024)

| def_team | epa_per_play_allowed | plays_allowed_per_game | rz_td_rate_allowed | home_def_adj | away_def_adj |
|----------|----------------------|------------------------|-------------------|--------------|--------------|
| SF       | -0.08                | 62.1                   | 48.2              | -0.02        | +0.01        |
| KC       | -0.05                | 64.3                   | 51.5              | -0.01        | +0.02        |
| DAL      | 0.02                 | 65.8                   | 55.0              | -0.03        | +0.03        |
| ATL      | 0.10                 | 59.5                   | 62.3              | +0.01        | -0.01        |
| DEN      | 0.12                 | 66.7                   | 65.8              | +0.02        | -0.02        |

---

## 3. Default Weights & Blending

### Weights:
- `w_fpa = 0.55`
- `w_epa = 0.20`
- `w_pace = 0.15`
- `w_rz = 0.10`

### Final SOS Score Formula:
```
sos_score = (
    w_fpa * fpa_percentile +
    w_epa * epa_percentile +
    w_pace * pace_percentile +
    w_rz * rz_percentile
) + venue_adjustment
```

---

## 4. Fallback Behavior

If context data is missing for a team/week:
- Use **league-average values** for that metric.
- Log a warning but do not fail the request.

---

## 5. Acceptance Criteria

- [ ] All metrics are percentile-scaled (0â€“100) within the league for that week.
- [ ] EPA and RZ metrics are inverted so higher = better for fantasy.
- [ ] Venue adjustment is small (Â±0â€“3 points) and applied last.
- [ ] Sample data matches the schema and ranges above.

---

Let me know if you need further refinement or additional metrics. This spec should provide a clear foundation for Grok (data pipeline) and Tiber (API/UI).