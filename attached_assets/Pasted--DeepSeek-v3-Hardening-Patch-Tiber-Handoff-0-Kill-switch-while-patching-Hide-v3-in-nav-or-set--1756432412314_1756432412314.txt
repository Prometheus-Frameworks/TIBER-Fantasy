ðŸ”§ DeepSeek v3 Hardening Patch (Tiber Handoff)
0) Kill switch while patching

Hide v3 in nav or set guards.dry_run=true in config/deepseek.v3.weights.json.

1) Normalization: admit only real, active players

File: server/services/sleeperDataNormalizationService.ts

Add these helpers (top of file):

const ACTIVE_OK = new Set(["Active", "Probable", "Questionable"]);
const BAD_STATUS = new Set(["IR","PUP","SUS","OUT","NFI","RET","RES","DNR","Injured Reserve","Practice Squad","Free Agent"]);

function isCurrentActive(p:any):boolean{
  // Sleeper payloads vary; be permissive but strict enough
  const teamOk = !!p.team && p.team !== "FA" && p.team !== "RET";
  const status = (p.status ?? p.injury_status ?? "").trim();
  const statusOk = (status === "" || ACTIVE_OK.has(status)); // treat empty as OK if team exists
  const bad = BAD_STATUS.has(status) || p.retired === true || p.active === false;
  return teamOk && statusOk && !bad;
}

function hasRecentUsage(stats:any):boolean{
  // Require minimal *recent* involvement (stops ghost vets)
  const routes = stats?.last4w_routes ?? 0;
  const targets = stats?.last4w_targets ?? 0;
  const rushAtt = stats?.last4w_rush_att ?? 0;
  return (routes >= 40) || (targets >= 10) || (rushAtt >= 25);
}

function posAgeCliff(pos:string, age:number){
  if (pos === "RB" && age >= 28) return true;
  if (pos === "WR" && age >= 32) return true;
  if (pos === "TE" && age >= 33) return false; // TEs age better, no hard cliff
  if (pos === "QB" && age >= 36) return false; // QBs age best
  return false;
}


When you build the normalized array, apply a strict filter:

const raw = await sleeperAPI.getAllPlayers(); // plus stats joins you already do
const norm = raw
  .map(normalizeOne) // your existing mapping â†’ {player_id,name,pos,team,age, ...stats}
  .filter(p => isCurrentActive(p))
  .filter(p => hasRecentUsage(p.stats ?? {}))
  .filter(p => !(p.pos === "WR" && posAgeCliff("WR", p.age ?? 0) && (p.stats?.last4w_routes ?? 0) < 80)); // WR 32+ must show strong usage


ADP join rule: never invent ADP.

// if no ADP, set to null (do NOT set huge fallback like 335)
p.adp = adpMap[p.player_id] ?? null;
p.delta_vs_adp = (p.adp && p.rank) ? Number((p.adp - p.rank).toFixed(1)) : null;

2) Scoring: punish nulls, enforce recent-usage floors, age cliffs

File: server/services/deepseekV3Service.ts

Add safe null floors below average (so missing data never helps):

const floor = {
  routeRate: 0.10, tgtShare: 0.08, rushShare: 0.10, rzTgtShare: 0.03, glRushShare: 0.05,
  talent: 20, explosiveness: 20, yakPerRec: 20, last6wPerf: 20, spike: 15, draftCapTier: 40, injRisk: 20
};
const nz = (n:number|undefined|null, f:number)=> (n==null? f : n);


Role (if nulls â†’ floors, not zeros):

function computeRole(p:V3Input):number{
  if (p.pos==="RB"){
    const rb = nz(p.rushShare, floor.rushShare)*0.6 + nz(p.glRushShare, floor.glRushShare)*0.4;
    return clamp(rb*100);
  }
  const r = nz(p.routeRate, floor.routeRate)*0.4 + nz(p.tgtShare, floor.tgtShare)*0.4 + nz(p.rzTgtShare, floor.rzTgtShare)*0.2;
  return clamp(r*100);
}


Talent / Recency / Risk (never neutralize to 0):

function computeTalent(p:V3Input):number{
  const t = nz(p.talentScore, floor.talent)*0.7 + nz(p.explosiveness, floor.explosiveness)*0.2 + nz(p.yakPerRec, floor.yakPerRec)*0.1;
  return clamp(t);
}
function computeRecency(p:V3Input):number{
  return clamp(nz(p.last6wPerf, floor.last6wPerf));
}
function computeRisk(p:V3Input):number{
  const cap = 100 - nz(p.draftCapTier, floor.draftCapTier); // lower capital â†’ higher risk
  return clamp(0.6*cap + 0.4*nz(p.injuryRisk, floor.injRisk));
}


Dynasty age-curve kicker (pushes out 31+ WR / 28+ RB unless usage is strong):

function ageCliffPenalty(pos:string, age:number){
  if (pos==="RB" && age>=28) return 12 + (age-28)*2;  // 12â€“25 pts
  if (pos==="WR" && age>=31) return 10 + (age-31)*2;  // 10â€“20 pts
  if (pos==="TE" && age>=33) return 6;                // light
  if (pos==="QB" && age>=36) return 4;                // minimal
  return 0;
}


In the dynasty path, subtract it from the final:

const agePenalty = (mode==="dynasty") ? ageCliffPenalty(p.pos, p.age ?? 0) : 0;
const score = (
  talentScore * cfg.talent +
  roleScore   * cfg.role +
  contextScore* cfg.context +
  durabilityScore* cfg.durability +
  recencyScore* cfg.recency +
  spikeScore  * cfg.spike -
  riskScore   * cfg.risk
) - agePenalty;


Hard gate right before pushing the row (stops ghost vets even after floors):

const recentRoutes = p.stats?.last4w_routes ?? 0;
const recentTgts   = p.stats?.last4w_targets ?? 0;
const recentRush   = p.stats?.last4w_rush_att ?? 0;
const passesFloor  = (p.pos==="RB")
  ? (recentRush >= 20 || recentTgts >= 6)
  : (recentRoutes >= 40 || recentTgts >= 10);

if (!passesFloor) continue; // do not include in rankings

3) Config nudge (dynasty risk up; redraft recency up)

File: config/deepseek.v3.weights.json

{
  "version": "3.0.1",
  "mode_defaults": {
    "dynasty": { "talent": 0.30, "role": 0.16, "context": 0.12, "durability": 0.10, "recency": 0.08, "spike": 0.06, "risk": 0.18 },
    "redraft": { "talent": 0.22, "role": 0.28, "context": 0.16, "durability": 0.08, "recency": 0.20, "spike": 0.06, "risk": 0.00 }
  },
  "tier_cutoffs": [96, 91, 86, 81, 76, 71],
  "guards": { "dry_run": true, "max_players": 1500, "require_sleeper_sync_ok": true, "allow_enrichment": true }
}


Dynasty: risk weight 0.18 (age cliffs + capital matter).

Redraft: lean harder on recency and role; riskâ‰ˆ0 so hot usage isnâ€™t over-penalized.

4) ADP join: never fabricate

File: server/services/deepseekV3Service.ts

export function attachAdpDelta(rows:any[], adpMap:Record<string, number>){
  return rows.map(r=>{
    const adp = adpMap[r.player_id] ?? null; // leave null if missing
    const delta_vs_adp = (adp && r.rank) ? Number((adp - r.rank).toFixed(1)) : null;
    return { ...r, adp, delta_vs_adp };
  });
}

5) Quick QA asserts (paste into psql / console)

Top-N must be active & recent:

-- No FA/PUP/SUS/RET in top 100
SELECT COUNT(*) FROM v3_rankings
WHERE rank <= 100 AND (status IN ('FA','PUP','SUS','RET') OR team IS NULL);
-- Expect 0


Age sanity (dynasty, WR 32+ scarce without usage):

SELECT COUNT(*) FROM v3_rankings
WHERE mode='dynasty' AND pos='WR' AND age>=32 AND rank<=50
  AND (recent_routes < 80 AND recent_targets < 15);
-- Expect 0


Variance (no identical wall at ~46):

SELECT COUNT(*) FROM (
  SELECT score, COUNT(*) c FROM v3_rankings WHERE rank<=100 GROUP BY score
) t WHERE c > 2;
-- Should be small (not huge clusters)

6) Recompute order

Pull Sleeper â†’ normalize with new filters.

Rebuild v3 (/api/rankings/deepseek/v3?mode=dynasty|redraft).

Eyeball Top 25 WR/RB.

Flip guards.dry_run=false and re-expose menu link.