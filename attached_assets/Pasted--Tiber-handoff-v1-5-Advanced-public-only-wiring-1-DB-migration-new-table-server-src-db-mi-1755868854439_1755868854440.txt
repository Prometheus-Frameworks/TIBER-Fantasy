üì¶ Tiber handoff ‚Äî v1.5 Advanced (public-only) wiring

1) DB migration (new table)

server/src/db/migrations/20250822_add_player_advanced_2024.sql

CREATE TABLE IF NOT EXISTS player_advanced_2024 (
  id SERIAL PRIMARY KEY,
  player_id TEXT,
  player_name TEXT,
  team TEXT,
  position TEXT,
  games SMALLINT,
  -- WR/TE
  adot NUMERIC,
  yprr NUMERIC,           -- null in v1.5
  racr NUMERIC,
  target_share NUMERIC,
  wopr NUMERIC,
  -- RB
  rush_expl_10p NUMERIC,
  -- QB
  aypa NUMERIC,
  epa_per_play NUMERIC
);

CREATE INDEX IF NOT EXISTS idx_padv24_pid ON player_advanced_2024(player_id);
CREATE INDEX IF NOT EXISTS idx_padv24_pos ON player_advanced_2024(position);

2) Load CSV

DELETE FROM player_advanced_2024;

\COPY player_advanced_2024(
  player_id,player_name,team,position,games,
  adot,yprr,racr,target_share,wopr,
  rush_expl_10p,aypa,epa_per_play
) FROM 'data/player_advanced_2024.csv' CSV HEADER;

3) Service join (expose in /leaders only when metric selected)
	‚Ä¢	Keep v1 dropdown as-is (Live metrics only).
	‚Ä¢	Add backend support to optionally select from player_advanced_2024 when metric ‚àà {adot, racr, target_share, wopr, rush_expl_10p, aypa} ‚Äî but do not add to dropdown yet unless you want to flip them on.
	‚Ä¢	For epa_per_play (QB): you now have two sources (seasonal and pbp). Prefer player_advanced_2024.epa_per_play if not null; else fallback to seasonal.

Query sketch (Kysely/Drizzle-ish):

const advancedMetrics = new Set(['adot','racr','target_share','wopr','rush_expl_10p','aypa','epa_per_play']);

export async function leaderboard2024({ position, metric, ...filters }) {
  const base = db.selectFrom('player_season_2024 as s')
    .leftJoin('player_advanced_2024 as a','a.player_id','s.player_id')
    .select([
      's.player_id','s.player_name','s.position','s.team','s.games',
      // prefer advanced epa when selected
      metric === 'epa_per_play'
        ? db.raw(`COALESCE(a.epa_per_play, s.epa_per_play)`).as('epa_per_play')
        : (advancedMetrics.has(metric) ? db.ref(`a.${metric}`) : db.ref(`s.${metric}`)).as(metric),
      's.fpts','s.fpts_ppr'
    ])
    .where('s.position','=',position)
    .where('s.games','>=',filters.min_games ?? 8);

  // thresholds
  // RB/WR/TE/QB same as before...

  // order & limit
  const dir = (filters.dir === 'asc') ? 'asc' : 'desc';
  return await base.orderBy(metric, dir).limit(filters.limit ?? 50).execute();
}

4) UI toggle (optional)
	‚Ä¢	Keep Coming Soon section with locks.
	‚Ä¢	If you want to soft-enable any public ones now (e.g., adot, target_share, aypa, rush_expl_10p), move them from ‚ÄúComing Soon‚Äù into the live list per position.
	‚Ä¢	Leave yprr locked (no routes), leave epa_per_play hidden from dropdown but it will still return if requested via API (your call; can 400 it).

5) QA updates (Claude)
	‚Ä¢	Add tests that a manual request for an advanced metric:
	‚Ä¢	400 if still gated, or
	‚Ä¢	returns values if enabled and present, with nulls where missing.
	‚Ä¢	Add regression ensuring RACR handles air_yards==0 safely (null, not crash).
	‚Ä¢	Add check that QB epa_per_play equals advanced value when available, otherwise seasonal.

‚∏ª
