interface PlayerProfile {
  breakawayRunRate?: number;
  yardsPerRouteRun?: number;
  totalTouches?: number;
  fumbles?: number;
  draftCapital?: string;
  gamesMissedLast2Seasons?: number;
  contractSecuredPastYear?: boolean;
  age?: number;
  isEliteRB?: boolean;
  backfieldCompetitionScore?: number; // New: 0-1, higher means more competition
  schemeFitScore?: number; // New: 0-1, higher means better fit
  adpValue?: number; // New: ADP rank
  touchesPerGame?: number; // New: Workload intensity
  debugLog?: string[];
}

const LEAGUE_AVG = {
  breakawayRunRate: 0.05, // Example, update annually
  yardsPerRouteRun: 1.5,
  fumbleRate: 1 / 80,
  gamesMissed: 3,
  ageThreshold: 25,
  adpInflationThreshold: 10, // ADP rank inflation
  touchesPerGame: 15,
};

function applyRBValueDeRisker(rb: PlayerProfile): number {
  let penalty = 0;
  const debug: string[] = [];

  // Breakaway Run Rate (dynamic penalty based on deviation)
  if (rb.breakawayRunRate !== undefined && rb.breakawayRunRate < LEAGUE_AVG.breakawayRunRate) {
    const deviation = (LEAGUE_AVG.breakawayRunRate - rb.breakawayRunRate) / LEAGUE_AVG.breakawayRunRate;
    const breakawayPenalty = Math.round(deviation * 4); // Max penalty: -4
    penalty -= breakawayPenalty;
    debug.push(`-${breakawayPenalty}: Low breakaway rate (${rb.breakawayRunRate})`);
  }

  // Receiving Efficiency
  if (rb.yardsPerRouteRun !== undefined && rb.yardsPerRouteRun < LEAGUE_AVG.yardsPerRouteRun) {
    const deviation = (LEAGUE_AVG.yardsPerRouteRun - rb.yardsPerRouteRun) / LEAGUE_AVG.yardsPerRouteRun;
    const receivingPenalty = Math.round(deviation * 3); // Max penalty: -3
    penalty -= receivingPenalty;
    debug.push(`-${receivingPenalty}: Weak receiving efficiency (${rb.yardsPerRouteRun})`);
  }

  // Fumble Risk
  if (rb.totalTouches && rb.fumbles && rb.fumbles / rb.totalTouches > LEAGUE_AVG.fumbleRate) {
    const fumblePenalty = Math.round((rb.fumbles / rb.totalTouches / LEAGUE_AVG.fumbleRate) * 2); // Max: -2
    penalty -= fumblePenalty;
    debug.push(`-${fumblePenalty}: Fumble risk`);
  }

  // Draft Capital
  if (rb.draftCapital && ['Day 3', 'UDFA'].includes(rb.draftCapital)) {
    penalty -= 3;
    debug.push('-3: Poor draft capital');
  }

  // Durability
  if (rb.gamesMissedLast2Seasons && rb.gamesMissedLast2Seasons > LEAGUE_AVG.gamesMissed) {
    const durabilityPenalty = Math.min(Math.round((rb.gamesMissedLast2Seasons - LEAGUE_AVG.gamesMissed) / 2), 3); // Max: -3
    penalty -= durabilityPenalty;
    debug.push(`-${durabilityPenalty}: Durability risk (${rb.gamesMissedLast2Seasons} games missed)`);
  }

  // Contract Security
  if (rb.contractSecuredPastYear === false) {
    penalty -= 1;
    debug.push('-1: No secure contract');
  }

  // Aging Curve
  if (rb.age && rb.age >= LEAGUE_AVG.ageThreshold && rb.isEliteRB !== true) {
    const agePenalty = Math.min(Math.round((rb.age - LEAGUE_AVG.ageThreshold) / 2), 3); // Max: -3
    penalty -= agePenalty;
    debug.push(`-${agePenalty}: Aging curve penalty (age ${rb.age})`);
  }

  // New: Backfield Competition
  if (rb.backfieldCompetitionScore && rb.backfieldCompetitionScore > 0.5) {
    const competitionPenalty = Math.round(rb.backfieldCompetitionScore * 2); // Max: -2
    penalty -= competitionPenalty;
    debug.push(`-${competitionPenalty}: High backfield competition`);
  }

  // New: Scheme Fit
  if (rb.schemeFitScore && rb.schemeFitScore < 0.5) {
    const schemePenalty = Math.round((0.5 - rb.schemeFitScore) * 4); // Max: -2
    penalty -= schemePenalty;
    debug.push(`-${schemePenalty}: Poor scheme fit`);
  }

  // New: ADP Inflation
  if (rb.adpValue && rb.adpValue < LEAGUE_AVG.adpInflationThreshold) {
    const adpPenalty = Math.round((LEAGUE_AVG.adpInflationThreshold - rb.adpValue) / 5); // Max: -2
    penalty -= adpPenalty;
    debug.push(`-${adpPenalty}: ADP inflation`);
  }

  // New: Workload Sustainability
  if (rb.touchesPerGame && rb.touchesPerGame > LEAGUE_AVG.touchesPerGame) {
    const workloadPenalty = Math.min(Math.round((rb.touchesPerGame - LEAGUE_AVG.touchesPerGame) / 5), 2); // Max: -2
    penalty -= workloadPenalty;
    debug.push(`-${workloadPenalty}: Unsustainable workload`);
  }

  rb.debugLog = rb.debugLog || [];
  rb.debugLog.push(`RBValueDe-risker applied: ${penalty} points`, ...debug);

  return penalty;
}