addMethodologyModule("WR Evaluation & Forecast Score (v1.0)", {
  description: "Scores a wide receiverâ€™s projected fantasy potential based on usage, efficiency, opportunity, and context.",
  triggerScope: ["dynastyValuation", "playerProfile", "performanceForecast"],
  inputValidation: {
    requiredFields: [
      "player.season",
      "player.position",
      "player.tpRR",
      "player.ypRR",
      "player.oneDRR",
      "player.firstReadTargetPct",
      "player.fantasyPointsPerGame",
      "player.dropRate",
      "player.routeWinRate",
      "player.age",
      "player.draftCapital",
      "player.explosivePlayRate",
      "player.slotRate",
      "player.routeParticipation",
      "player.teamPassAttemptsPerGame",
      "player.wrRoomTargetCompetition",
      "player.qbStabilityScore"
    ],
    defaults: {
      season: 2024,
      tpRR: 0.18,
      ypRR: 1.75,
      oneDRR: 0.075,
      firstReadTargetPct: 0.22,
      fantasyPointsPerGame: 8.5,
      dropRate: 0.05,
      routeWinRate: 50,
      age: 24,
      draftCapital: "Round 4",
      explosivePlayRate: 0.12,
      slotRate: 0.30,
      routeParticipation: 0.85,
      teamPassAttemptsPerGame: 30.5,
      wrRoomTargetCompetition: 1.5,
      qbStabilityScore: 0.55
    },
    validation: [
      "If player.position !== 'WR', return contextScore: 0",
      "Clamp routeWinRate to 0-100",
      "Clamp dropRate to 0-1"
    ]
  },
  logic: ({ player }) => {
    if (player.position !== "WR") return { logs: ["Not a WR. Skipped."], contextScore: 0, lastEvaluatedSeason: 2024 };

    let contextScore = 0;
    const logs = [];

    if (player.ypRR > 2.0) { contextScore += 0.4; logs.push("Elite YPRR"); }
    if (player.tpRR > 0.22) { contextScore += 0.3; logs.push("High Target Per Route Rate"); }
    if (player.oneDRR > 0.085) { contextScore += 0.3; logs.push("Elite 1D/RR"); }
    if (player.firstReadTargetPct > 0.25) { contextScore += 0.2; logs.push("Strong 1st Read Target Rate"); }
    if (player.explosivePlayRate > 0.15) { contextScore += 0.2; logs.push("Explosive after catch"); }
    if (player.routeWinRate > 60) { contextScore += 0.2; logs.push("High route win rate"); }
    if (player.routeWinRate < 45) { contextScore -= 0.2; logs.push("Below avg. route win rate"); }
    if (player.dropRate > 0.08) { contextScore -= 0.2; logs.push("Drop issues"); }
    if (player.slotRate >= 0.25 && player.slotRate <= 0.60) { contextScore += 0.1; logs.push("Slot versatility"); }
    if (player.qbStabilityScore < 0.4) { contextScore -= 0.2; logs.push("Poor QB environment"); }
    if (player.wrRoomTargetCompetition > 2) { contextScore -= 0.15; logs.push("High WR target competition"); }

    if (player.draftCapital === "UDFA") { contextScore -= 0.3; logs.push("Undrafted"); }
    if (["Round 1", "Round 2", "Round 3"].includes(player.draftCapital)) { contextScore += 0.2; logs.push("Strong draft capital"); }

    if (player.age > 29) { contextScore -= 0.15; logs.push("Age regression risk"); }

    return {
      logs,
      contextScore: Math.max(0, Math.min(contextScore, 5)),
      lastEvaluatedSeason: player.season
    };
  }
});