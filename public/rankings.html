<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rankings</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .toggle { padding: 10px 20px; margin: 5px; cursor: pointer; border: 1px solid #ddd; }
        .active { background: #0079f2; color: white; }
        .player-card { background: #f0f8ff; padding: 10px; border: 1px solid #ddd; margin: 5px 0; border-radius: 4px; }
        .toggle-section { margin: 15px 0; }
        .toggle-section h3 { margin: 5px 0; font-size: 16px; }
        .sources { margin-top: 30px; font-size: 12px; color: #666; }
    </style>
</head>
<body>

<h1>Rankings</h1>

<div id="league-toggles">
    <button class="toggle active" data-league="standard">Standard</button>
    <button class="toggle" data-league="half-ppr">Half-PPR</button>
    <button class="toggle" data-league="ppr">PPR</button>
</div>

<div class="toggle-section">
    <h3>League Type:</h3>
    <button class="toggle active" data-mode="dynasty">Dynasty</button>
    <button class="toggle" data-mode="redraft">Redraft</button>
</div>

<div id="position-toggles" class="toggle-section">
    <h3>Position Filter:</h3>
    <button class="toggle active" data-position="all">All</button>
    <button class="toggle" data-position="QB">QB</button>
    <button class="toggle" data-position="RB">RB</button>
    <button class="toggle" data-position="WR">WR</button>
    <button class="toggle" data-position="TE">TE</button>
</div>

<div id="player-list"></div>
<div id="sources" class="sources"></div>

<script>
    let currentSettings = {
        mode: 'dynasty',
        leagueFormat: 'ppr',
        position: 'all'
    };

    function renderPlayers(mode = 'dynasty', leagueFormat = 'ppr', position = 'all') {
        currentSettings = { mode, leagueFormat, position };
        
        let url = `/api/rankings?mode=${mode}&league_format=${leagueFormat}`;
        if (position !== 'all') {
            url += `&position=${position}`;
        }
        console.log('Fetching rankings from:', url);
        
        fetch(url)
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Rankings data received:', data);
                const container = document.getElementById('player-list');
                const sourcesContainer = document.getElementById('sources');
                container.innerHTML = '';
                sourcesContainer.innerHTML = '';
                
                const players = data.players || data;
                if (!players || !Array.isArray(players)) {
                    console.error('No valid players array in response:', data);
                    container.innerHTML = '<div class="player-card">No players data available</div>';
                    return;
                }
                
                players.forEach((player, index) => {
                    const div = document.createElement('div');
                    div.className = 'player-card';
                    const vorp = player.VORPScore || player.vorp_score || player.vorp || 'N/A';
                    const playerName = player.playerName || player.player_name || 'Unknown';
                    const age = player.age ? ` (Age: ${player.age})` : '';
                    const tier = player.tier ? ` â€¢ Tier ${player.tier}` : '';
                    const rank = index + 1;
                    
                    div.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>#${rank} ${playerName}</strong> (${player.position} - ${player.team})${age}
                                <br>VORP: <span style="color: #007acc; font-weight: bold;">${typeof vorp === 'number' ? vorp.toFixed(2) : vorp}</span>${tier}
                            </div>
                            <div style="font-size: 12px; color: #666;">
                                ${player.projected_fpts ? `${player.projected_fpts.toFixed(1)} pts` : ''}
                            </div>
                        </div>
                    `;
                    container.appendChild(div);
                });

                // Show metadata and sources
                let metaInfo = '';
                if (data.meta) {
                    metaInfo += `<div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                        <strong>Mode:</strong> ${data.meta.mode.toUpperCase()} | 
                        <strong>Format:</strong> ${data.meta.league_format.toUpperCase()} | 
                        <strong>Players:</strong> ${data.meta.totalPlayers} | 
                        <strong>Tiers:</strong> ${data.meta.tierCount}
                        ${data.meta.is_superflex ? ' | <span style="color: #28a745;">SUPERFLEX</span>' : ''}
                    </div>`;
                }
                
                if (data.sources && data.sources.length > 0) {
                    metaInfo += '<div style="font-size: 12px; color: #666;"><strong>Sources:</strong> ' + data.sources.join(', ') + '</div>';
                }
                
                sourcesContainer.innerHTML = metaInfo;
            })
            .catch(error => {
                console.error('Error fetching rankings:', error);
                const container = document.getElementById('player-list');
                container.innerHTML = '<div class="player-card">Error loading rankings: ' + error.message + '</div>';
            });
    }

    // Add listener for league toggles
    document.querySelectorAll('#league-toggles .toggle').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('#league-toggles .toggle').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const league = btn.getAttribute('data-league');
            const currentMode = document.querySelector('.toggle.active[data-mode]').getAttribute('data-mode');
            const currentPosition = document.querySelector('.toggle.active[data-position]').getAttribute('data-position');
            renderPlayers(currentMode, league, currentPosition);
        });
    });

    // Dynasty/Redraft toggle listener
    document.querySelectorAll('.toggle[data-mode]').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.toggle[data-mode]').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const mode = btn.getAttribute('data-mode');
            const currentLeague = document.querySelector('#league-toggles .toggle.active').getAttribute('data-league');
            const currentPosition = document.querySelector('.toggle.active[data-position]').getAttribute('data-position');
            renderPlayers(mode, currentLeague, currentPosition);
        });
    });

    // Position filter toggle listener
    document.querySelectorAll('.toggle[data-position]').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.toggle[data-position]').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const position = btn.getAttribute('data-position');
            const currentMode = document.querySelector('.toggle.active[data-mode]').getAttribute('data-mode');
            const currentLeague = document.querySelector('#league-toggles .toggle.active').getAttribute('data-league');
            renderPlayers(currentMode, currentLeague, position);
        });
    });

    renderPlayers(); // Default load
</script>

</body>
</html>